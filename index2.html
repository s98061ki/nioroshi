<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SS品質管理サポート</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Calm Professional (Background: stone-50, Cards: white/stone-100, Accent: sky-600, Warning: red-600) -->
    <!-- Application Structure Plan: 利用者の役割（品質管理者・新入社員）とタスクに基づいた、ダッシュボード中心の対話型構造を採用。ナビゲーションで「ダッシュボード」「日常点検」「品質規格」「緊急時対応」「学習モード」を切り替えることで、情報の検索性を高め、直感的な操作を実現。この設計は、資料の法的・形式的な構成をそのまま再現するのではなく、現場での使いやすさを最優先し、必要な情報へ迅速にアクセスできることを目的としています。 -->
    <!-- Visualization & Content Choices: 報告書情報：品質不適合の原因 -> 目標：原因の比較・理解 -> 表示方法：棒グラフ（Chart.js）-> 操作：ホバーで詳細表示 -> 理由：最も一般的な問題点を視覚的に示し、予防策への意識を高めるため。報告書情報：燃料油の品質規格 -> 目標：規格の参照・確認 -> 表示方法：対話型HTMLテーブル＋JSフィルタ -> 理由：PDFからの検索より遥かに高速で規格を確認できるため。報告書情報：緊急時対応手順 -> 目標：緊急時の行動支援 -> 表示方法：ステップ形式のウィザード（HTML/JS）-> 理由：危機的状況下での認知負荷を軽減し、正確な手順実行を確実にするため。 -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body { font-family: 'Noto JP', 'Inter', sans-serif; }
        /* 正楷書体は一般的なWebフォントではないため、代替として筆記体風のフォントを指定し、serifをフォールバックとします */
        @font-face {
            font-family: 'Kaisho';
            src: local('Kaisyo'), local('Japanese Calligraphic'), local('Hosofude'), serif; /* 一般的なシステムフォントでの近似 */
            /* もしWebフォントのURLがあれば以下のように記述 */
            /* url('path/to/your/kaisho-font.woff2') format('woff2'); */
        }
        .chart-container { position: relative; width: 100%; max-width: 600px; margin-left: auto; margin-right: auto; height: 300px; max-height: 400px; }
        @media (min-width: 768px) { .chart-container { height: 350px; } }
        .nav-item { transition: all 0.2s ease-in-out; }
        .nav-item.active { border-bottom-color: #0284c7; color: #0284c7; font-weight: 600; }
        .page { display: none; }
        .page.active { display: block; }
        .task-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .tab-button.active { background-color: #0ea5e9; color: white; }
        /* Flex container for navigation rows */
        .nav-rows { display: flex; flex-direction: column; }
        .nav-row { display: flex; flex-wrap: wrap; }
        /* 行動指針の表示調整 */
        .slogan-text {
            font-family: 'Kaisho', 'Noto JP', serif;
            font-size: 1.125rem; /* text-lg */
            font-weight: 500; /* font-medium */
            color: #57534e; /* text-stone-700 */
            text-align: center; /* 中央揃え */
            white-space: normal; /* 自然な改行を許可 */
            word-break: keep-all; /* 単語の途中での改行を避ける */
            width: 100%; /* 親要素の幅いっぱいに広げる */
        }
        /* スマートフォン表示での行動指針のフォントサイズ調整 */
        @media (max-width: 640px) {
            .slogan-text {
                font-size: 1rem; /* スマホで小さめに */
            }
        }
        /* Emergency tab styles */
        .emergency-tab-container {
            display: flex;
            flex-wrap: wrap;
            border-bottom: 2px solid #e2e8f0; /* stone-200 */
            margin-bottom: 1.5rem;
        }
        .emergency-tab-button {
            padding: 0.75rem 1.25rem;
            font-weight: 600;
            color: #71717a; /* stone-500 */
            border-radius: 0.375rem 0.375rem 0 0;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            display: flex; /* アイコンとテキストを横並びにする */
            align-items: center; /* 垂直方向中央揃え */
        }
        .emergency-tab-button span {
            margin-right: 0.5rem; /* アイコンとテキストの間にスペース */
            display: flex; /* SVGが中央に表示されるようにflexを追加 */
            align-items: center;
            justify-content: center;
        }
        .emergency-tab-button:hover {
            color: #0ea5e9; /* sky-600 */
        }
        .emergency-tab-button.active {
            color: #0ea5e9; /* sky-600 */
            border-bottom-color: #0ea5e9;
        }
        .emergency-tab-content {
            display: none;
        }
        .emergency-tab-content.active {
            display: block;
        }
    </style>
</head>
<body class="bg-stone-50 text-stone-800">
    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                <div>
                    <h1 class="text-3xl font-bold text-stone-900 flex items-center">
                        <span class="text-sky-600 mr-3">⛽</span> 品質管理・荷卸しポータル
                    </h1>
                </div>
            </div>
            <p class="slogan-text mt-4">
                バロン・パークグループ 行動指針<br>「安全・安心を第一に考え、信用・信頼される企業を目指します。」
            </p>
        </header>

        <!-- Latest News Section (Moved above navigation) -->
        <section id="latest-news-section" class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-lg shadow-sm mb-6">
            <h2 class="text-lg font-semibold mb-2 text-blue-800 flex items-center">
                <span class="mr-2 text-xl">✨</span> 新着情報
            </h2>
            <ul class="list-disc list-inside text-sm text-blue-700 space-y-1">
               <li><span class="font-bold">2025年6月26日:</span> 本社からの通知FAX「6月11日　荷卸し立会い優秀者」をアップしました。</li>
                <li><span class="font-bold">2025年6月26日:</span> 資料「品確法教育用資料」「端切りの重要性と品確法」をアップしました。</li>
                <li><span class="font-bold">2025年6月26日:</span> 学習モード　テスト内容をアップデートしました。</li>
            </ul>
        </section>

        <nav class="bg-white rounded-lg shadow-sm mb-6 sticky top-0 z-10">
            <div class="nav-rows">
                <ul id="main-nav-row-1" class="nav-row border-b border-stone-200">
                    <li><a href="#dashboard" class="nav-item p-4 block border-b-4 border-transparent text-stone-600 hover:text-sky-600"><span class="mr-2 text-xl">📊</span>ダッシュボード</a></li>
                    <li><a href="#daily-checks" class="nav-item p-4 block border-b-4 border-transparent text-stone-600 hover:text-sky-600"><span class="mr-2 text-xl">✅</span>日常点検</a></li>
                    <li><a href="#fax-notifications" class="nav-item p-4 block border-b-4 border-transparent text-stone-600 hover:text-sky-600"><span class="mr-2 text-xl">📠</span>本社からの通知FAX</a></li>
                    <li><a href="#standards" class="nav-item p-4 block border-b-4 border-transparent text-stone-600 hover:text-sky-600"><span class="mr-2 text-xl">📋</span>品質規格</a></li>
                </ul>
                <ul id="main-nav-row-2" class="nav-row">
                    <li><a href="#emergency" class="nav-item p-4 block border-b-4 border-transparent text-stone-600 hover:text-sky-600"><span class="mr-2 text-xl">🚨</span>緊急時対応</a></li>
                    <!-- 学習モードのナビゲーションリンクを更新 -->
                    <li><a href="https://s98061ki.github.io/nioroshi/index3.html" target="_blank" class="nav-item p-4 block border-b-4 border-transparent text-stone-600 hover:text-sky-600"><span class="mr-2 text-xl">💡</span>学習モード</a></li>
                    <li><a href="https://www.youtube.com/playlist?list=PLBXIDWHV_3_1W-3Byazg5ELS3LxmkLJL_" target="_blank" class="nav-item p-4 block border-b-4 border-transparent text-stone-600 hover:text-sky-600"><span class="mr-2 text-xl">🎥</span>動画で見る</a></li>
                    <li><a href="#documents" class="nav-item p-4 block border-b-4 border-transparent text-stone-600 hover:text-sky-600"><span class="mr-2 text-xl">📄</span>資料</a></li>
                    <li><a href="#incident-assistant" class="nav-item p-4 block border-b-4 border-transparent text-stone-600 hover:text-sky-600"><span class="mr-2 text-xl">💬</span>AI事故アシスタント</a></li>
                </ul>
            </div>
        </nav>

        <main>
            <!-- Dashboard Page -->
            <section id="dashboard-page" class="page">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-sm">
                        <h2 class="text-xl font-semibold mb-4 text-stone-800">品質不適合の主な原因</h2>
                        <p class="text-sm text-stone-500 mb-4">過去の事例から、品質トラブルの主な原因を理解し、日常業務での予防意識を高めましょう。特にホース内の滞油（端切り）とローリーからのコンタミが大きな要因です。</p>
                        <div class="chart-container">
                            <canvas id="causesChart"></canvas>
                        </div>
                    </div>
                    <div class="space-y-6">
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <h3 class="font-semibold text-lg text-stone-800">クイックアクセス</h3>
                            <p class="text-sm text-stone-500 mb-4">主要な業務へ素早く移動します。</p>
                            <div class="space-y-3">
                                <a href="#daily-checks" class="nav-link-internal block w-full text-center bg-sky-500 text-white font-semibold py-3 px-4 rounded-lg hover:bg-sky-600 transition duration-200">日常点検を開始</a>
                                <a href="#emergency" class="nav-link-internal block w-full text-center bg-red-500 text-white font-semibold py-3 px-4 rounded-lg hover:bg-red-600 transition duration-200">緊急時対応手順</a>
                                <!-- 学習モードのクイックアクセスリンクを更新 -->
                                <a href="https://s98061ki.github.io/nioroshi/index3.html" target="_blank" class="block w-full text-center bg-green-500 text-white font-semibold py-3 px-4 rounded-lg hover:bg-green-600 transition duration-200">学習モード</a>
                                <a href="#fax-notifications" class="nav-link-internal block w-full text-center bg-purple-500 text-white font-semibold py-3 px-4 rounded-lg hover:bg-purple-600 transition duration-200">本社からの通知FAX</a>
                                <a href="#incident-assistant" class="nav-link-internal block w-full text-center bg-blue-500 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-600 transition duration-200">✨AI事故アシスタントを試す</a>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Daily Checks Page -->
            <section id="daily-checks-page" class="page">
                 <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h2 class="text-2xl font-bold mb-2 text-stone-800">日常点検業務</h2>
                    <p class="text-stone-600 mb-6">ここでは、日々の業務で実施する品質管理のための点検手順を確認できます。各項目を確実に実施し、記録することで、品質トラブルを未然に防ぎます。</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- 端切り -->
                        <div class="bg-stone-100 p-6 rounded-lg transition duration-300 task-card">
                            <h3 class="text-lg font-semibold mb-2 flex items-center"><span class="text-2xl mr-3">✂️</span>「端切り」の実施</h3>
                            <p class="text-sm text-stone-600 mb-4">ホース内の滞油による品質劣化を防ぐ最重要作業です。特に販売頻度の低い油種（例：夏季の灯油）は必須です。</p>
                            <details class="text-sm">
                                <summary class="font-medium text-sky-600 cursor-pointer">手順詳細</summary>
                                <ol class="list-decimal list-inside mt-2 space-y-2 text-stone-700">
                                    <li>計量機ノズルから2L程度の燃料を抜き取る。</li>
                                    <li>特に灯油は、抜き取った油を透明な容器に入れ、水道水と比較し着色がないか確認する。（簡易色相チェック）</li>
                                    <li>試買検査の前には必ず実施する。</li>
                                </ol>
                            </details>
                        </div>
                        <!-- 荷卸し立会い -->
                        <div class="bg-stone-100 p-6 rounded-lg transition duration-300 task-card">
                            <h3 class="text-lg font-semibold mb-2 flex items-center"><span class="text-2xl mr-3">🚚</span>荷卸し時の立会い・確認</h3>
                            <p class="text-sm text-stone-600 mb-4">コンタミネーション（異油種・水分混入）を防ぐため、荷卸し時の確認を徹底します。</p>
                             <details class="text-sm">
                                <summary class="font-medium text-sky-600 cursor-pointer">確認項目</summary>
                                <ul class="list-disc list-inside mt-2 space-y-2 text-stone-700">
                                    <li>受入油種と数量の確認。</li>
                                    <li>注油口とホースの正しい結合を確認。</li>
                                    <li>地下タンクの在庫量（受入前・後）の確認。</li>
                                    <li>ローリー乗務員と相互に配管内の残油がないか確認。</li>
                                </ul>
                            </details>
                        </div>
                        <!-- 目視確認 -->
                        <div class="bg-stone-100 p-6 rounded-lg transition duration-300 task-card">
                             <h3 class="text-lg font-semibold mb-2 flex items-center"><span class="text-2xl mr-3">👀</span>水分混入の目視確認</h3>
                            <p class="text-sm text-stone-600 mb-4">計量機から吐出される油の状態を日常的に観察し、水コンタミの初期兆候を発見します。</p>
                            <details class="text-sm">
                                <summary class="font-medium text-sky-600 cursor-pointer">チェックポイント</summary>
                                <ul class="list-disc list-inside mt-2 space-y-2 text-stone-700">
                                    <li>吐出油が白濁していないか？</li>
                                    <li>エア噛みのような音や振動はないか？</li>
                                    <li>在庫管理表で在庫量の不自然な増加はないか？</li>
                                    <li>集中豪雨や台風の後には特に注意する。</li>
                                </ul>
                            </details>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Standards Page -->
            <section id="standards-page" class="page">
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h2 class="text-2xl font-bold mb-2 text-stone-800">燃料油品質規格</h2>
                    <p class="text-stone-600 mb-6">品確法で定められた燃料油の品質規格（強制規格・標準規格）を検索・確認できます。油種を選択してください。</p>
                    <div class="mb-4">
                        <select id="fuel-type-selector" class="w-full md:w-1/3 p-2 border border-stone-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
                            <option value="gasoline">揮発油（ガソリン）</option>
                            <option value="diesel">軽油</option>
                            <option value="kerosene" selected>灯油</option>
                        </select>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-stone-500">
                            <thead class="text-xs text-stone-700 uppercase bg-stone-100">
                                <tr>
                                    <th scope="col" class="px-3 py-2 sm:px-6 sm:py-3">項目</th>
                                    <th scope="col" class="px-3 py-2 sm:px-6 sm:py-3">基準</th>
                                    <th scope="col" class="px-3 py-2 sm:px-6 sm:py-3">観点</th>
                                    <th scope="col" class="px-3 py-2 sm:px-6 sm:py-3">規格</th>
                                </tr>
                            </thead>
                            <tbody id="standards-table-body">
                                <!-- JS will populate this -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Emergency Page -->
            <section id="emergency-page" class="page">
                 <div class="bg-red-50 border-l-4 border-red-500 p-6 rounded-lg shadow-sm">
                    <h2 class="text-2xl font-bold mb-2 text-red-800">緊急時対応手順</h2>
                    <p class="text-red-700 mb-6">品質クレーム、火災、地震など、緊急事態発生時の対応手順を以下のタブから選択して確認してください。</p>

                    <div class="emergency-tab-container" id="emergency-tabs">
                        <div class="emergency-tab-button active" data-tab="suspected-contamination"><span>❓</span>コンタミの疑い</div>
                        <div class="emergency-tab-button" data-tab="confirmed-contamination"><span>❗</span>コンタミ</div>
                        <div class="emergency-tab-button" data-tab="fire"><span>🔥</span>火災</div>
                        <div class="emergency-tab-button" data-tab="earthquake">
                            <span>
                                <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-activity">
                                    <path d="M22 12H18L15 21L9 3L6 12H2"/>
                                </svg>
                            </span>南海トラフ地震
                        </div>
                    </div>

                    <div id="emergency-tab-contents">
                        <!-- Suspected Contamination Tab Content -->
                        <div class="emergency-tab-content active" id="suspected-contamination-content">
                            <h3 class="text-xl font-bold text-red-600 mb-3">コンタミの疑い時の対応</h3>
                            <div class="space-y-4 text-stone-700">
                                <div class="p-4 bg-white rounded-lg shadow-md">
                                    <h4 class="font-semibold text-stone-800 mb-1">1. 直ちに販売を停止</h4>
                                    <p class="text-sm">お客様からのクレームや、自身の確認で異常を発見した場合、該当する計量機での販売を<strong>直ちに停止</strong>してください。これが最優先事項です。</p>
                                </div>
                                <div class="p-4 bg-white rounded-lg shadow-md">
                                    <h4 class="font-semibold text-stone-800 mb-1">2. 責任者への報告</h4>
                                    <p class="text-sm">速やかに品質管理者または店長へ状況を報告してください。自己判断で対応を続けないでください。</p>
                                </div>
                                <div class="p-4 bg-white rounded-lg shadow-md">
                                    <h4 class="font-semibold text-stone-800 mb-1">3. 顧客への聞き取り</h4>
                                    <p class="text-sm">給油日時、給油した油種、車両の症状（例: エンスト、異音、加速不良）などを詳しく聞き取ってください。可能であれば、連絡先を控えてください。</p>
                                </div>
                                <div class="p-4 bg-white rounded-lg shadow-md">
                                    <h4 class="font-semibold text-stone-800 mb-1">4. サンプル採取</h4>
                                    <p class="text-sm">該当する計量機ノズルから少量の燃料を透明な容器に抜き取り、目視で色や濁り、異物の有無を確認してください。可能であれば、地下タンクからもサンプルを採取してください。</p>
                                </div>
                                <div class="p-4 bg-white rounded-lg shadow-md">
                                    <h4 class="font-semibold text-stone-800 mb-1">5. 状況記録</h4>
                                    <p class="text-sm">発見日時、担当者名、発見経緯、顧客情報（氏名、連絡先、車両情報）、初期対応内容などを詳細に記録してください。</p>
                                </div>
                                <div class="p-4 bg-white rounded-lg shadow-md">
                                    <h4 class="font-semibold text-stone-800 mb-1">6. 専門業者への連絡</h4>
                                    <p class="text-sm">必要に応じて、燃料分析を行う専門業者や保守業者に連絡し、指示を仰いでください。</p>
                                </div>
                            </div>
                        </div>

                        <!-- Confirmed Contamination Tab Content -->
                        <div class="emergency-tab-content" id="confirmed-contamination-content">
                            <h3 class="text-xl font-bold text-red-600 mb-3">コンタミ事故発生時の対応</h3>
                            <p class="text-sm text-stone-600 mb-4">コンタミが確定した場合の対応です。特に、関係機関への迅速な連絡が重要です。</p>
                            <div class="space-y-4 text-stone-700">
                                <div class="p-4 bg-white rounded-lg shadow-md">
                                    <h4 class="font-semibold text-stone-800 mb-1">1. 直ちに販売を停止</h4>
                                    <p class="text-sm">最優先で該当する計量機およびタンクからの販売を停止し、顧客への影響拡大を防ぎます。</p>
                                </div>
                                <div class="p-4 bg-white rounded-lg shadow-md">
                                    <h4 class="font-semibold text-stone-800 mb-1">2. 責任者への報告</h4>
                                    <p class="text-sm">品質管理者または店長へ直ちに状況を報告し、今後の対応方針を協議します。</p>
                                </div>
                                <!-- 既存の関係機関への連絡を再利用 -->
                                <div class="p-4 bg-white rounded-lg shadow-md">
                                    <h4 class="font-semibold text-stone-800 mb-1">3. 関係機関への連絡</h4>
                                    <p class="text-stone-700 mb-4">品質管理者又は店長は、以下の関係機関へ速やかに連絡してください。</p>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div class="border border-stone-200 p-4 rounded-lg">
                                            <h4 class="font-semibold text-stone-800">① 最寄りの消防本部</h4>
                                            <p class="text-sm text-stone-600">事故の経緯、対応状況を報告。</p>
                                        </div>
                                        <div class="border border-stone-200 p-4 rounded-lg">
                                            <h4 class="font-semibold text-stone-800">② 元売事業者</h4>
                                            <p class="text-sm text-stone-600">社内規定に基づき連絡。</p>
                                        </div>
                                        <div class="border border-stone-200 p-4 rounded-lg md:col-span-2">
                                            <h4 class="font-semibold text-stone-800">③ 中部経済産業局 資源・燃料課</h4>
                                            <p class="text-lg font-mono font-bold my-2"><a href="tel:052-951-2781" class="text-sky-600 hover:underline">📞 052-951-2781</a></p>
                                            <details class="text-sm">
                                                <summary class="font-medium text-sky-600 cursor-pointer">伝えるべき事項</summary>
                                                <ol class="list-decimal list-inside mt-2 space-y-1 text-stone-700">
                                                    <li>販売事業者名、給油所名</li>
                                                    <li>給油所所在地</li>
                                                    <li>連絡が取れる電話番号</li>
                                                    <li>コンタミの概要（例：灯油に揮発油混入）</li>
                                                    <li>直前に当該燃料の荷卸しを受けた事業者名</li>
                                                </ol>
                                                <p class="mt-2 text-xs text-stone-500">※休日・時間外は留守番電話に応答メッセージを残してください。</p>
                                            </details>
                                        </div>
                                    </div>
                                </div>
                                <div class="p-4 bg-white rounded-lg shadow-md">
                                    <h4 class="font-semibold text-stone-800 mb-1">4. 影響範囲の特定</h4>
                                    <p class="text-sm">どのタンク、どの計量機、いつから影響があったのかを特定し、該当顧客の情報を収集します。</p>
                                </div>
                                <div class="p-4 bg-white rounded-lg shadow-md">
                                    <h4 class="font-semibold text-stone-800 mb-1">5. 詳細なサンプル採取と分析手配</h4>
                                    <p class="text-sm">コンタミの状況を正確に把握するため、必要に応じて複数の場所からサンプルを採取し、専門機関での分析を手配します。</p>
                                </div>
                                <div class="p-4 bg-white rounded-lg shadow-md">
                                    <h4 class="font-semibold text-stone-800 mb-1">6. 汚染燃料の隔離・抜き取り手配</h4>
                                    <p class="text-sm">汚染された燃料がこれ以上拡散しないよう隔離し、専門業者による抜き取り、またはタンク清掃の手配を行います。</p>
                                </div>
                                <div class="p-4 bg-white rounded-lg shadow-md">
                                    <h4 class="font-semibold text-stone-800 mb-1">7. 顧客対応</h4>
                                    <p class="text-sm">影響を受けたお客様に対しては、誠意をもって状況を説明し、今後の対応（車両点検、修理、補償など）について案内します。</p>
                                </div>
                            </div>
                        </div>

                        <!-- Fire Tab Content -->
                        <div class="emergency-tab-content" id="fire-content">
                            <h3 class="text-xl font-bold text-red-600 mb-3">火災発生時の対応</h3>
                            <p class="text-sm text-stone-600 mb-4">SS内で火災が発生した場合の基本的な対応です。従業員と顧客の安全確保が最優先です。</p>
                            <div class="space-y-4 text-stone-700">
                                <div class="p-4 bg-white rounded-lg shadow-md">
                                    <h4 class="font-semibold text-stone-800 mb-1">1. 初期消火（可能な場合）</h4>
                                    <p class="text-sm">火災を発見したら、すぐに「火事だ！」と大声で周囲に知らせ、安全が確保できる範囲で消火器などによる初期消火を行います。</p>
                                </div>
                                <div class="p-4 bg-white rounded-lg shadow-md">
                                    <h4 class="font-semibold text-stone-800 mb-1">2. 従業員・顧客の安全確保・避難誘導</h4>
                                    <p class="text-sm">初期消火が困難な場合や、火が拡大する恐れがある場合は、直ちに消火を諦め、従業員と顧客の安全確保を最優先し、安全な場所へ避難誘導します。</p>
                                </div>
                                <div class="p-4 bg-white rounded-lg shadow-md">
                                    <h4 class="font-semibold text-stone-800 mb-1">3. 速やかに119番通報</h4>
                                    <p class="text-sm">火災の状況（場所、何が燃えているか、負傷者の有無など）を正確に伝え、消防隊の到着を待ちます。</p>
                                </div>
                                <div class="p-4 bg-white rounded-lg shadow-md">
                                    <h4 class="font-semibold text-stone-800 mb-1">4. 責任者への報告</h4>
                                    <p class="text-sm">店長や本社など、関係する責任者へ速やかに状況を報告します。</p>
                                </div>
                                <div class="p-4 bg-white rounded-lg shadow-md">
                                    <h4 class="font-semibold text-stone-800 mb-1">5. 周辺への注意喚起・進入禁止措置</h4>
                                    <p class="text-sm">周囲の人々への危険を知らせ、火災現場への不用意な立ち入りを防ぎます。</p>
                                </div>
                                <div class="p-4 bg-white rounded-lg shadow-md">
                                    <h4 class="font-semibold text-stone-800 mb-1">6. 燃料供給の緊急停止</h4>
                                    <p class="text-sm">燃料の二次災害を防ぐため、緊急停止ボタンなどで燃料供給を停止します。</p>
                                </div>
                            </div>
                            <p class="mt-4 text-sm text-red-600 font-semibold">※詳細な手順や訓練については、別途社内マニュアルを参照してください。</p>
                        </div>

                        <!-- Nankai Trough Earthquake Tab Content -->
                        <div class="emergency-tab-content" id="earthquake-content">
                            <h3 class="text-xl font-bold text-red-600 mb-3">南海トラフ地震発生時の対応</h3>
                            <p class="text-sm text-stone-600 mb-4">南海トラフ地震発生時の対応です。大規模災害に備え、迅速かつ冷静な行動が求められます。</p>
                            <div class="space-y-4 text-stone-700">
                                <div class="p-4 bg-white rounded-lg shadow-md">
                                    <h4 class="font-semibold text-stone-800 mb-1">1. 身の安全確保（シェイクアウト）</h4>
                                    <p class="text-sm">地震発生時は、まず身の安全を確保します。頭を守り、揺れが収まるまで姿勢を低くして身を守ってください。</p>
                                </div>
                                <div class="p-4 bg-white rounded-lg shadow-md">
                                    <h4 class="font-semibold text-stone-800 mb-1">2. 従業員・顧客の安全確認</h4>
                                    <p class="text-sm">揺れが収まったら、従業員と顧客の安否を確認し、負傷者がいる場合は応急処置を行います。</p>
                                </div>
                                <div class="p-4 bg-white rounded-lg shadow-md">
                                    <h4 class="font-semibold text-stone-800 mb-1">3. 燃料供給ラインの緊急遮断</h4>
                                    <p class="text-sm">火災や漏洩を防ぐため、計量機や地下タンクへの燃料供給を緊急停止します。</p>
                                </div>
                                <div class="p-4 bg-white rounded-lg shadow-md">
                                    <h4 class="font-semibold text-stone-800 mb-1">4. 計量機・タンク周辺の安全確認</h4>
                                    <p class="text-sm">燃料の漏洩や機器の損傷がないか、計量機や地下タンク周辺を慎重に確認します。</p>
                                </div>
                                <div class="p-4 bg-white rounded-lg shadow-md">
                                    <h4 class="font-semibold text-stone-800 mb-1">5. 施設全体の点検</h4>
                                    <p class="text-sm">建屋の損傷、落下物、危険物の転倒など、施設全体の安全状況を確認します。</p>
                                </div>
                                <div class="p-4 bg-white rounded-lg shadow-md">
                                    <h4 class="font-semibold text-stone-800 mb-1">6. 責任者への報告</h4>
                                    <p class="text-sm">被災状況と対応状況を店長や本社へ報告します。連絡手段が途絶える可能性も考慮し、複数の手段を検討します。</p>
                                </div>
                                <div class="p-4 bg-white rounded-lg shadow-md">
                                    <h4 class="font-semibold text-stone-800 mb-1">7. 二次災害防止</h4>
                                    <p class="text-sm">火の元の確認、危険物の安全な場所への移動など、二次災害の発生を防ぐ措置を講じます。</p>
                                </div>
                                <div class="p-4 bg-white rounded-lg shadow-md">
                                    <h4 class="font-semibold text-stone-800 mb-1">8. 災害情報収集と共有</h4>
                                    <p class="text-sm">テレビ、ラジオ、インターネットなどで最新の災害情報を収集し、従業員や顧客と共有します。</p>
                                </div>
                            </div>
                            <p class="mt-4 text-sm text-red-600 font-semibold">※詳細な手順や訓練については、別途社内マニュアルや地域の防災計画を参照してください。</p>
                        </div>
                    </div>
                 </div>
            </section>

            <!-- Learning Page -->
            <section id="learning-page" class="page">
                 <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h2 class="text-2xl font-bold mb-2 text-stone-800">学習モード</h2>
                    <p class="text-stone-600 mb-6">品質管理の基本をクイズ形式で学びましょう。新入社員の教育や、知識の再確認にご活用ください。</p>
                    <div class="text-center">
                        <p class="text-stone-700 mb-4">以下のボタンをクリックして、学習サイトへ移動してください。</p>
                        <a href="https://s98061ki.github.io/nioroshi/index3.html" target="_blank" class="inline-block bg-green-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-green-600 transition duration-200 text-lg">
                            学習サイトへGO!
                        </a>
                    </div>
                </div>
            </section>

            <!-- Documents Page -->
            <section id="documents-page" class="page">
                 <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h2 class="text-2xl font-bold mb-2 text-stone-800">資料</h2>
                    <p class="text-stone-600 mb-6">品質管理に関連する重要な資料はこちらから参照できます。</p>
                    <div class="space-y-4">
                        <a href="https://drive.google.com/file/d/1UHO6SKxEOz2kWs8qQOAXXhSQbnDxCtD7/view?usp=sharing" target="_blank" class="flex items-center p-4 bg-stone-100 rounded-lg hover:bg-stone-200 transition duration-200">
                            <span class="text-red-500 text-2xl mr-3">📄</span>
                            <span class="font-medium text-stone-800">品確法教育用資料「給油所の運営にあたって」.pdf</span>
                        </a>
                        <a href="https://drive.google.com/file/d/1UGrY8OLCYYnKBcGPC05YijzyrWC8DdiG/view?usp=sharing" target="_blank" class="flex items-center p-4 bg-stone-100 rounded-lg hover:bg-stone-200 transition duration-200">
                            <span class="text-red-500 text-2xl mr-3">📄</span>
                            <span class="font-medium text-stone-800">端切りの重要性と品確法2025.pdf</span>
                        </a>
                    </div>
                </div>
            </section>

            <!-- FAX Notifications Page -->
            <section id="fax-notifications-page" class="page">
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h2 class="text-2xl font-bold mb-2 text-stone-800">本社からの通知FAX</h2>
                    <p class="text-stone-600 mb-6">本社から発信された品質管理に関するFAX通知を、日付の新しい順に確認できます。</p>
                    <div id="fax-files-list" class="space-y-4">
                        <!-- FAX files will be populated here by JS -->
                    </div>
                </div>
            </section>

            <!-- Incident Assistant Page -->
            <section id="incident-assistant-page" class="page">
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h2 class="text-2xl font-bold mb-2 text-stone-800">AI事故アシスタント ✨</h2>
                    <p class="text-stone-600 mb-6">品質に関する事故や異常が発生した際に、その状況を入力してください。AIが原因の可能性や、推奨される対応を提案します。</p>
                    <div class="mb-4">
                        <label for="incident-description" class="block text-stone-700 text-sm font-bold mb-2">事故の状況を具体的に入力してください:</label>
                        <textarea id="incident-description" class="shadow appearance-none border rounded w-full py-3 px-4 text-stone-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-sky-500" rows="6" placeholder="例: お客様が給油後、エンジンの不調を訴えました。直前に大雨がありました。"></textarea>
                        <div id="incident-input-message" class="mt-2 text-red-600 text-sm hidden"></div>
                    </div>
                    <button id="analyze-incident-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg focus:outline-none focus:shadow-outline transition duration-200">
                        ✨ 状況を分析する
                    </button>
                    <div id="incident-analysis-result" class="mt-6 p-4 bg-stone-100 rounded-lg shadow hidden">
                        <p class="text-stone-500 text-center" id="analysis-loading-indicator">分析中...</p>
                        <div id="analysis-content" class="hidden">
                            <h3 class="text-xl font-semibold mb-3 text-stone-800">分析結果</h3>
                            <div class="mb-4">
                                <h4 class="font-semibold text-stone-700 mb-1">事象の要約:</h4>
                                <p id="analysis-summary" class="text-stone-600"></p>
                            </div>
                            <div class="mb-4">
                                <h4 class="font-semibold text-stone-700 mb-1">考えられる原因/確認事項:</h4>
                                <ul id="analysis-causes" class="list-disc list-inside text-stone-600"></ul>
                            </div>
                            <div class="mb-4">
                                <h4 class="font-semibold text-stone-700 mb-1">推奨される初動対応:</h4>
                                <ul id="analysis-actions" class="list-disc list-inside text-stone-600">
                                    <li>直ちに該当油種の販売を停止し、<a href="#emergency" class="text-sky-600 hover:underline nav-link-internal">緊急時対応手順</a>を参照してください。</li>
                                </ul>
                            </div>
                            <div>
                                <h4 class="font-semibold text-stone-700 mb-1">追加で収集すべき情報:</h4>
                                <ul id="analysis-info" class="list-disc list-inside text-stone-600"></ul>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const app = {
                state: {
                    currentPage: 'dashboard',
                },

                // FAXファイルデータはここに一元化
                faxFilesData: [
                    { date: '20250611', name: '20250611荷卸し立会い優秀者.pdf', url: 'https://drive.google.com/file/d/1AiIySyEUoYK-eFX7864nI-UgHQi0_iwZ/view?usp=sharing' },
                    { date: '20250510', name: '20250510監査セルフチェックリスト.pdf', url: 'https://drive.google.com/file/d/1oi0xjmfGx-PyCWFXovYQJMAy1DnwM09j/view?usp=sharing' },
                    { date: '20250505', name: '20250505荷卸し作業動画.pdf', url: 'https://drive.google.com/file/d/1PLYGxN2hYC5gaBy3Gtn9QNVFbOUwcfte/view?usp=sharing' },
                    { date: '20250404', name: '20250404監査総括2025年3月.pdf', url: 'https://drive.google.com/file/d/18v8va-18Vt2I8TPTyQBOsFy6sbjFU2GK/view?usp=sharing' },
                    { date: '20250307', name: '20250307立ち会い時のハンディ使用について.pdf', url: 'https://drive.google.com/file/d/1r2VN6IpjOUb8cJnBPy1ggAMssZFJeTDK/view?usp=sharing' },
                    { date: '20250306', name: '20250306黒本の増減率について.pdf', url: 'https://drive.google.com/file/d/1y3V6Ijb4WFzgvFTJeNeue5WC9ZkvGWDz/view?usp=sharing' },
                    { date: '20250306', name: '20250306監査総括2025年2月分.pdf', url: 'https://drive.google.com/file/d/14pf2VX1i5hqCNg7waSTKrhzwYVgs93S0/view?usp=sharing' },
                    { date: '20250213', name: '20250213新人の荷卸し教育について.pdf', url: 'https://drive.google.com/file/d/1Sr0YgCBeRsGqo5jlLoA4hQMeZeGDVQTg/view?usp=sharing' },
                    { date: '20250210', name: '20250210開店時間前の荷卸しについて.pdf', url: 'https://drive.google.com/file/d/1AGkCpQaG45OcI4jkfhGaaHFPR5RSedGR/view?usp=sharing' },
                    { date: '20250206', name: '20250206前尺プリントのタイミングについて.pdf', url: 'https://drive.google.com/file/d/1rTS73u4vp_fMTRsrAzKU4CG3Sq-Sgxi3/view?usp=sharing' },
                    { date: '20250205', name: '20250205品質分析結果通知書の注意点.pdf', url: 'https://drive.google.com/file/d/1-eZR8ZqaoYrBc1bc8xr0ZdkgkXLl5xvu/view?usp=sharing' },
                    { date: '20250131', name: '20250131荷卸し立会い強化月間.pdf', url: 'https://drive.google.com/file/d/110ZbtZ1jtS7289Klhw6bG9ukUMrmCODt/view?usp=sharing' },
                ],

                // ルーティングを初期化するメソッド
                initRouter() {
                    const navLinks = document.querySelectorAll('.nav-item');
                    navLinks.forEach(link => {
                        // 外部リンクは対象外とする
                        if (link.getAttribute('href').startsWith('http') || link.getAttribute('href').startsWith('https')) {
                            return;
                        }
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            const pageId = link.getAttribute('href').substring(1); // #を除去
                            this.navigateTo(pageId);
                        });
                    });
                    // 初期のページをURLハッシュから取得、なければダッシュボード
                    const initialPage = window.location.hash ? window.location.hash.substring(1) : 'dashboard';
                    this.navigateTo(initialPage);
                },

                // ページ遷移を実行するメソッド
                navigateTo(pageId) {
                    this.state.currentPage = pageId;
                    window.location.hash = pageId; // URLハッシュを更新
                    this.renderPage();
                },

                // ページを描画するメソッド
                renderPage() {
                    // 全てのページを非表示にする
                    document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
                    // 現在のページを表示する
                    const newPage = document.getElementById(`${this.state.currentPage}-page`);
                    if (newPage) {
                        newPage.classList.add('active');
                    } else {
                        // ページが見つからない場合はダッシュボードを表示
                        document.getElementById('dashboard-page').classList.add('active');
                    }

                    // ナビゲーションアイテムのアクティブ状態を更新
                    document.querySelectorAll('.nav-item').forEach(link => {
                        // 外部リンクはアクティブ状態の管理対象外
                        if (link.getAttribute('href').startsWith('http') || link.getAttribute('href').startsWith('https')) {
                            link.classList.remove('active');
                            return;
                        }
                        if (link.getAttribute('href') === `#${this.state.currentPage}`) {
                            link.classList.add('active');
                        } else {
                            link.classList.remove('active');
                        }
                    });
                },

                // 品質不適合原因のグラフデータ
                causesData: {
                    labels: ['ホース内滞油(端切り不足)', 'ローリーからのコンタミ', '計量機・配管の劣化', '施設への水分侵入', 'その他'],
                    datasets: [{
                        label: '不適合件数（イメージ）',
                        data: [45, 30, 15, 8, 2], // データはパーセンテージで表示されるように調整
                        backgroundColor: ['#38bdf8', '#60a5fa', '#93c5fd', '#bfdbfe', '#e0f2fe'],
                        borderColor: ['#0284c7', '#2563eb', '#60a5fa', '#93c5fd', '#dbeafe'],
                        borderWidth: 1
                    }]
                },

                // グラフを初期化するメソッド
                initCharts() {
                    const ctx = document.getElementById('causesChart').getContext('2d');
                    new Chart(ctx, {
                        type: 'bar',
                        data: this.causesData,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            indexAxis: 'y', // 横棒グラフにする
                            scales: {
                                x: {
                                    beginAtZero: true,
                                    title: { display: true, text: '発生頻度 (%)' } // タイトルをパーセンテージに
                                }
                            },
                            plugins: {
                                legend: { display: false }, // 凡例を非表示
                                title: { display: false }, // タイトルを非表示
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return ` ${context.dataset.label}: ${context.raw}%`; // ツールチップの表示形式を調整
                                        }
                                    }
                                }
                            }
                        }
                    });
                },

                // 品質規格データ
                standardsData: {
                    gasoline: [
                        { item: '鉛', spec: '検出されないこと', reason: '環境(大気汚染防止)', type: '強制' },
                        { item: '硫黄分', spec: '0.001質量%(10ppm)以下', reason: '環境(大気汚染防止)', type: '強制' },
                        { item: 'ベンゼン', spec: '1体積%以下', reason: '健康被害防止', type: '強制' },
                        { item: '灯油混入率', spec: '4体積%以下', reason: 'エンジントラブル防止', type: '強制' },
                        { item: '色', spec: 'オレンジ色', reason: '灯油との誤使用防止', type: '標準' },
                        { item: 'オクタン価', spec: '1号(ハイオク)96以上, 2号(レギュラー)89以上', reason: '運転時の快適性', type: '標準' },
                    ],
                    diesel: [
                        { item: '硫黄分', spec: '0.001質量%(10ppm)以下', reason: '環境(大気汚染防止)', type: '強制' },
                        { item: 'セタン指数', spec: '45以上', reason: '環境(大気汚染防止)', type: '強制' },
                        { item: '蒸留性状(90%留出温度)', spec: '360℃以下', reason: '環境(大気汚染防止)', type: '強制' },
                        { item: '引火点', spec: '45℃以上', reason: '安全性', type: '標準' },
                        { item: '流動点', spec: '季節・地域により異なる', reason: '運転時の快適性', type: '標準' },
                    ],
                    kerosene: [
                        { item: '硫黄分', spec: '0.008質量%(80ppm)以下', reason: '環境(大気汚染防止)', type: '強制' },
                        { item: '引火点', spec: '40℃以上', reason: '消費者安全の確保', type: '強制' },
                        { item: '色', spec: 'セーボルト色が+25以上 (無色透明)', reason: 'ガソリンとの誤使用防止', type: '標準' },
                        { item: '煙点', spec: '23mm以上', reason: '快適性', type: '標準' },
                    ]
                },

                // 品質規格テーブルを初期化するメソッド
                initStandardsTable() {
                    // デフォルトで灯油の規格を表示
                    this.renderStandardsTable('kerosene');
                },

                // 品質規格テーブルを描画するメソッド
                renderStandardsTable(fuelType) {
                    const tableBody = document.getElementById('standards-table-body');
                    tableBody.innerHTML = ''; // テーブルの内容をクリア

                    const data = this.standardsData[fuelType] || []; // 選択された油種のデータを取得
                    data.forEach(std => {
                        const row = document.createElement('tr');
                        row.className = 'bg-white border-b hover:bg-stone-50';
                        row.innerHTML = `
                            <td class="px-3 py-2 sm:px-6 sm:py-4 font-medium text-stone-900 whitespace-nowrap">${std.item}</td>
                            <td class="px-3 py-2 sm:px-6 sm:py-4">${std.spec}</td>
                            <td class="px-3 py-2 sm:px-6 sm:py-4 break-words">${std.reason}</td>
                            <td class="px-3 py-2 sm:px-6 sm:py-4">
                                <span class="px-2 py-1 font-semibold leading-tight rounded-full ${std.type === '強制' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">
                                    ${std.type}
                                </span>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                },

                // FAXファイルリストを初期化するメソッド
                initFaxFilesList() {
                    const faxFilesListContainer = document.getElementById('fax-files-list');
                    faxFilesListContainer.innerHTML = ''; // コンテンツをクリア

                    // 日付の新しい順にソート (8桁の数字プレフィックスでソート)
                    // faxFilesDataはすでにアプリのプロパティとして定義されているので、ここでは再定義しない
                    this.faxFilesData.sort((a, b) => b.date.localeCompare(a.date));

                    this.faxFilesData.forEach(file => {
                        const fileLink = document.createElement('a');
                        fileLink.href = file.url;
                        fileLink.target = "_blank";
                        fileLink.className = "flex items-center p-4 bg-stone-100 rounded-lg hover:bg-stone-200 transition duration-200";
                        fileLink.innerHTML = `
                            <span class="text-xl mr-3">🖷</span> <!-- FAXの絵文字に変更 -->
                            <span class="font-medium text-stone-800">${file.name}</span>
                        `;
                        faxFilesListContainer.appendChild(fileLink);
                    });
                },

                // AI事故アシスタントを初期化するメソッド
                async initIncidentAssistant() {
                    const analyzeButton = document.getElementById('analyze-incident-btn');
                    const descriptionInput = document.getElementById('incident-description');
                    const incidentInputMessage = document.getElementById('incident-input-message'); // 新しいメッセージ表示要素
                    const resultDiv = document.getElementById('incident-analysis-result');
                    const loadingIndicator = document.getElementById('analysis-loading-indicator');
                    const analysisContent = document.getElementById('analysis-content');
                    const analysisSummary = document.getElementById('analysis-summary');
                    const analysisCauses = document.getElementById('analysis-causes');
                    const analysisActions = document.getElementById('analysis-actions');
                    const analysisInfo = document.getElementById('analysis-info');

                    analyzeButton.addEventListener('click', async () => {
                        const incidentDescription = descriptionInput.value.trim();
                        if (!incidentDescription) {
                            incidentInputMessage.textContent = '事故の状況を入力してください。';
                            incidentInputMessage.classList.remove('hidden');
                            resultDiv.classList.add('hidden'); // 結果表示を隠す
                            return;
                        } else {
                            incidentInputMessage.classList.add('hidden'); // 入力があればメッセージを隠す
                        }

                        resultDiv.classList.remove('hidden');
                        loadingIndicator.classList.remove('hidden');
                        analysisContent.classList.add('hidden');
                        analysisCauses.innerHTML = '';
                        analysisInfo.innerHTML = '';
                        // デフォルトの初動対応をリセットして再追加
                        analysisActions.innerHTML = '<li>直ちに該当油種の販売を停止し、<a href="#emergency" class="text-sky-600 hover:underline nav-link-internal">緊急時対応手順</a>を参照してください。</li>';

                        try {
                            const prompt = `あなたはガソリンスタンドの品質管理アシスタントです。以下の事故状況を分析し、事象の要約、考えられる原因/確認事項（箇条書き）、推奨される初動対応（箇条書き）、および追加で収集すべき情報（箇条書き）をJSON形式で提供してください。原因は具体的な可能性を複数挙げてください。
事故状況: ${incidentDescription}

JSONフォーマットの例:
{
  "summary": "要約テキスト",
  "causes": ["原因1", "原因2", "原因3"],
  "actions": ["行動1", "行動2"],
  "info_to_gather": ["情報1", "情報2"]
}`;
                            let chatHistory = [];
                            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                            const payload = {
                                contents: chatHistory,
                                generationConfig: {
                                    responseMimeType: "application/json",
                                    responseSchema: {
                                        type: "OBJECT",
                                        properties: {
                                            "summary": { "type": "STRING" },
                                            "causes": { "type": "ARRAY", "items": { "type": "STRING" } },
                                            "actions": { "type": "ARRAY", "items": { "type": "STRING" } },
                                            "info_to_gather": { "type": "ARRAY", "items": { "type": "STRING" } }
                                        },
                                        "propertyOrdering": ["summary", "causes", "actions", "info_to_gather"]
                                    }
                                }
                            };
                            // APIキーをここに設定
                            const apiKey = "AIzaSyB4moqcE2Gr21_puDDsFyITUT3zfSNG9ls";
                            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                            const response = await fetch(apiUrl, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });

                            const result = await response.json();

                            if (result.candidates && result.candidates.length > 0 &&
                                result.candidates[0].content && result.candidates[0].content.parts &&
                                result.candidates[0].content.parts.length > 0) {
                                const jsonText = result.candidates[0].content.parts[0].text;
                                const parsedJson = JSON.parse(jsonText);

                                analysisSummary.textContent = parsedJson.summary;
                                parsedJson.causes.forEach(cause => {
                                    const li = document.createElement('li');
                                    li.textContent = cause;
                                    analysisCauses.appendChild(li);
                                });
                                // デフォルトのアクションを維持しつつ、LLMからの新しいアクションを追加
                                parsedJson.actions.forEach(action => {
                                    // 既存のデフォルトアクションと重複しないようにチェック
                                    if (!analysisActions.textContent.includes(action)) {
                                        const li = document.createElement('li');
                                        li.textContent = action;
                                        analysisActions.appendChild(li);
                                    }
                                });
                                parsedJson.info_to_gather.forEach(info => {
                                    const li = document.createElement('li');
                                    li.textContent = info;
                                    analysisInfo.appendChild(li);
                                });

                                loadingIndicator.classList.add('hidden');
                                analysisContent.classList.remove('hidden');
                            } else {
                                loadingIndicator.textContent = '分析結果を取得できませんでした。';
                                console.error('Unexpected LLM response structure:', result);
                            }
                        } catch (error) {
                            loadingIndicator.textContent = '分析中にエラーが発生しました。';
                            console.error('Error calling LLM:', error);
                        } finally {
                            // 新しく追加されたコンテンツ内の内部ナビゲーションリンクにイベントリスナーを再付与
                            document.querySelectorAll('#incident-analysis-result .nav-link-internal').forEach(link => {
                                // 既存のリスナーを削除してから新しいリスナーを追加 (複数回のクリックで重複するのを防ぐ)
                                link.removeEventListener('click', app.internalNavLinkHandler);
                                link.addEventListener('click', app.internalNavLinkHandler);
                            });
                        }
                    });

                    // ハンドラーを一度定義し、容易に削除・追加できるようにする
                    this.internalNavLinkHandler = (e) => {
                        e.preventDefault();
                        const targetId = e.target.getAttribute('href').substring(1);
                        this.navigateTo(targetId);
                    };
                },

                // 緊急時対応タブを初期化するメソッド
                initEmergencyTabs() {
                    const tabContainer = document.getElementById('emergency-tabs');
                    const tabContents = document.getElementById('emergency-tab-contents');

                    if (!tabContainer || !tabContents) return;

                    // 初期表示タブを設定（例：コンタミの疑い）
                    const defaultTabId = 'suspected-contamination';
                    this.showEmergencyTab(defaultTabId);

                    tabContainer.addEventListener('click', (e) => {
                        if (e.target.closest('.emergency-tab-button')) { // 親要素も含むように変更
                            const tabId = e.target.closest('.emergency-tab-button').dataset.tab;
                            this.showEmergencyTab(tabId);
                        }
                    });
                },

                // 緊急時対応タブを表示するメソッド
                showEmergencyTab(tabId) {
                    // すべてのタブボタンとタブコンテンツのアクティブ状態を解除
                    document.querySelectorAll('.emergency-tab-button').forEach(button => button.classList.remove('active'));
                    document.querySelectorAll('.emergency-tab-content').forEach(content => content.classList.remove('active'));

                    // 指定されたタブボタンとタブコンテンツをアクティブにする
                    const selectedButton = document.querySelector(`.emergency-tab-button[data-tab="${tabId}"]`);
                    const selectedContent = document.getElementById(`${tabId}-content`);

                    if (selectedButton) {
                        selectedButton.classList.add('active');
                    }
                    if (selectedContent) {
                        selectedContent.classList.add('active');
                    }
                },


                // 全ての初期化処理を実行するメソッド
                init() {
                    this.initRouter(); // ルーティングの初期化
                    this.renderPage(); // 初期ページの描画
                    this.initCharts(); // グラフの初期化
                    this.initStandardsTable(); // 品質規格テーブルの初期化
                    this.initFaxFilesList(); // FAXファイルリストの初期化
                    this.initIncidentAssistant(); // AI事故アシスタントの初期化
                    this.initEmergencyTabs(); // 緊急時対応タブの初期化

                    // 燃料油種セレクターの変更イベントリスナー
                    document.getElementById('fuel-type-selector').addEventListener('change', (e) => this.renderStandardsTable(e.target.value));

                    // 内部ナビゲーションリンクに対するイベントリスナー（クイックアクセス用など）
                    document.querySelectorAll('.nav-link-internal').forEach(link => {
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            const targetId = link.getAttribute('href').substring(1);
                            this.navigateTo(targetId);
                        });
                    });
                }
            };

            app.init(); // アプリケーションの初期化を開始
        });
    </script>
</body>
</html>

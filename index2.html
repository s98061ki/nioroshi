<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SS品質管理サポート</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Calm Professional (Background: stone-50, Cards: white/stone-100, Accent: sky-600, Warning: red-600) -->
    <!-- Application Structure Plan: 利用者の役割（品質管理者・新入社員）とタスクに基づいた、ダッシュボード中心の対話型構造を採用。ナビゲーションで「ダッシュボード」「日常点検」「品質規格」「緊急時対応」「学習モード」を切り替えることで、情報の検索性を高め、直感的な操作を実現。この設計は、資料の法的・形式的な構成をそのまま再現するのではなく、現場での使いやすさを最優先し、必要な情報へ迅速にアクセスできることを目的としています。 -->
    <!-- Visualization & Content Choices: 報告書情報：品質不適合の原因 -> 目標：原因の比較・理解 -> 表示方法：棒グラフ（Chart.js）-> 操作：ホバーで詳細表示 -> 理由：最も一般的な問題点を視覚的に示し、予防策への意識を高めるため。報告書情報：燃料油の品質規格 -> 目標：規格の参照・確認 -> 表示方法：対話型HTMLテーブル＋JSフィルタ -> 理由：PDFからの検索より遥かに高速で規格を確認できるため。報告書情報：緊急時対応手順 -> 目標：緊急時の行動支援 -> 表示方法：ステップ形式のウィザード（HTML/JS）-> 理由：危機的状況下での認知負荷を軽減し、正確な手順実行を確実にするため。 -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body { font-family: 'Noto Sans JP', 'Inter', sans-serif; }
        /* 正楷書体は一般的なWebフォントではないため、代替として筆記体風のフォントを指定し、serifをフォールバックとします */
        @font-face {
            font-family: 'Kaisho';
            src: local('Kaisyo'), local('Japanese Calligraphic'), local('Hosofude'), serif; /* 一般的なシステムフォントでの近似 */
            /* もしWebフォントのURLがあれば以下のように記述 */
            /* url('path/to/your/kaisho-font.woff2') format('woff2'); */
        }
        .chart-container { position: relative; width: 100%; max-width: 600px; margin-left: auto; margin-right: auto; height: 300px; max-height: 400px; }
        @media (min-width: 768px) { .chart-container { height: 350px; } }
        .nav-item { transition: all 0.2s ease-in-out; }
        .nav-item.active { border-bottom-color: #0284c7; color: #0284c7; font-weight: 600; }
        .page { display: none; }
        .page.active { display: block; }
        .task-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .tab-button.active { background-color: #0ea5e9; color: white; }
        /* Flex container for navigation rows */
        .nav-rows { display: flex; flex-direction: column; }
        .nav-row { display: flex; flex-wrap: wrap; }
        /* 行動指針の表示調整 */
        .slogan-text {
            font-family: 'Kaisho', 'Noto Sans JP', serif;
            font-size: 1.125rem; /* text-lg */
            font-weight: 500; /* font-medium */
            color: #57534e; /* text-stone-700 */
            text-align: center; /* 中央揃え */
            white-space: normal; /* 自然な改行を許可 */
            word-break: keep-all; /* 単語の途中での改行を避ける */
            width: 100%; /* 親要素の幅いっぱいに広げる */
        }
        /* スマートフォン表示での行動指針のフォントサイズ調整 */
        @media (max-width: 640px) {
            .slogan-text {
                font-size: 1rem; /* スマホで小さめに */
            }
        }
    </style>
</head>
<body class="bg-stone-50 text-stone-800">

    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                <div>
                    <h1 class="text-3xl font-bold text-stone-900 flex items-center">
                        <span class="text-sky-600 mr-3">⛽</span> 品質管理・荷卸しポータル
                    </h1>
                </div>
                <!-- 最終データ更新日を削除 -->
            </div>
            <p class="slogan-text mt-4">
                バロン・パークグループ 行動指針<br>「安全・安心を第一に考え、信用・信頼される企業を目指します。」
            </p>
        </header>

        <!-- Latest News Section (Moved above navigation) -->
        <section id="latest-news-section" class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-lg shadow-sm mb-6">
            <h2 class="text-lg font-semibold mb-2 text-blue-800 flex items-center">
                <span class="mr-2 text-xl">✨</span> 新着情報
            </h2>
            <ul class="list-disc list-inside text-sm text-blue-700 space-y-1">
               <li><span class="font-bold">2025年6月26日:</span> 本社からの通知FAX「6月11日　荷卸し立会い優秀者」をアップしました。</li>
                <li><span class="font-bold">2025年6月26日:</span> 資料「品確法教育用資料」「端切りの重要性と品確法」をアップしました。</li>
                <li><span class="font-bold">2025年6月26日:</span> 学習モード　テスト内容をアップデートしました。</li>
                
            </ul>
        </section>

        <nav class="bg-white rounded-lg shadow-sm mb-6 sticky top-0 z-10">
            <div class="nav-rows">
                <ul id="main-nav-row-1" class="nav-row border-b border-stone-200">
                    <li><a href="#dashboard" class="nav-item p-4 block border-b-4 border-transparent text-stone-600 hover:text-sky-600"><span class="mr-2 text-xl">📊</span>ダッシュボード</a></li>
                    <li><a href="#daily-checks" class="nav-item p-4 block border-b-4 border-transparent text-stone-600 hover:text-sky-600"><span class="mr-2 text-xl">✅</span>日常点検</a></li>
                    <li><a href="#fax-notifications" class="nav-item p-4 block border-b-4 border-transparent text-stone-600 hover:text-sky-600"><span class="mr-2 text-xl">📠</span>本社からの通知FAX</a></li>
                    <li><a href="#standards" class="nav-item p-4 block border-b-4 border-transparent text-stone-600 hover:text-sky-600"><span class="mr-2 text-xl">📋</span>品質規格</a></li>
                </ul>
                <ul id="main-nav-row-2" class="nav-row">
                    <li><a href="#emergency" class="nav-item p-4 block border-b-4 border-transparent text-stone-600 hover:text-sky-600"><span class="mr-2 text-xl">🚨</span>緊急時対応</a></li>
                    <li><a href="https://s98061ki.github.io/nioroshi/" target="_blank" class="nav-item p-4 block border-b-4 border-transparent text-stone-600 hover:text-sky-600"><span class="mr-2 text-xl">💡</span>学習モード</a></li>
                    <li><a href="https://www.youtube.com/playlist?list=PLBXIDWHV_3_1W-3Byazg5ELS3LxmkLJL_" target="_blank" class="nav-item p-4 block border-b-4 border-transparent text-stone-600 hover:text-sky-600"><span class="mr-2 text-xl">🎥</span>動画で見る</a></li>
                    <li><a href="#documents" class="nav-item p-4 block border-b-4 border-transparent text-stone-600 hover:text-sky-600"><span class="mr-2 text-xl">📄</span>資料</a></li>
                    <li><a href="#incident-assistant" class="nav-item p-4 block border-b-4 border-transparent text-stone-600 hover:text-sky-600"><span class="mr-2 text-xl">💬</span>AI事故アシスタント</a></li>
                </ul>
            </div>
        </nav>

        <main>
            <!-- Dashboard Page -->
            <section id="dashboard-page" class="page">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-sm">
                        <h2 class="text-xl font-semibold mb-4 text-stone-800">品質不適合の主な原因</h2>
                        <p class="text-sm text-stone-500 mb-4">過去の事例から、品質トラブルの主な原因を理解し、日常業務での予防意識を高めましょう。特にホース内の滞油（端切り）とローリーからのコンタミが大きな要因です。</p>
                        <div class="chart-container">
                            <canvas id="causesChart"></canvas>
                        </div>
                    </div>
                    <div class="space-y-6">
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <h3 class="font-semibold text-lg text-stone-800">クイックアクセス</h3>
                            <p class="text-sm text-stone-500 mb-4">主要な業務へ素早く移動します。</p>
                            <div class="space-y-3">
                                <a href="#daily-checks" class="nav-link-internal block w-full text-center bg-sky-500 text-white font-semibold py-3 px-4 rounded-lg hover:bg-sky-600 transition duration-200">日常点検を開始</a>
                                <a href="#emergency" class="nav-link-internal block w-full text-center bg-red-500 text-white font-semibold py-3 px-4 rounded-lg hover:bg-red-600 transition duration-200">緊急時対応手順</a>
                                <a href="https://s98061ki.github.io/nioroshi/" target="_blank" class="block w-full text-center bg-green-500 text-white font-semibold py-3 px-4 rounded-lg hover:bg-green-600 transition duration-200">学習モード</a>
                                <a href="#fax-notifications" class="nav-link-internal block w-full text-center bg-purple-500 text-white font-semibold py-3 px-4 rounded-lg hover:bg-purple-600 transition duration-200">本社からの通知FAX</a>
                                <a href="#incident-assistant" class="nav-link-internal block w-full text-center bg-blue-500 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-600 transition duration-200">✨AI事故アシスタントを試す</a>
                            </div>
                        </div>
                        
                        </div>
                    </div>
                </div>
            </section>

            <!-- Daily Checks Page -->
            <section id="daily-checks-page" class="page">
                 <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h2 class="text-2xl font-bold mb-2 text-stone-800">日常点検業務</h2>
                    <p class="text-stone-600 mb-6">ここでは、日々の業務で実施する品質管理のための点検手順を確認できます。各項目を確実に実施し、記録することで、品質トラブルを未然に防ぎます。</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- 端切り -->
                        <div class="bg-stone-100 p-6 rounded-lg transition duration-300 task-card">
                            <h3 class="text-lg font-semibold mb-2 flex items-center"><span class="text-2xl mr-3">✂️</span>「端切り」の実施</h3>
                            <p class="text-sm text-stone-600 mb-4">ホース内の滞油による品質劣化を防ぐ最重要作業です。特に販売頻度の低い油種（例：夏季の灯油）は必須です。</p>
                            <details class="text-sm">
                                <summary class="font-medium text-sky-600 cursor-pointer">手順詳細</summary>
                                <ol class="list-decimal list-inside mt-2 space-y-2 text-stone-700">
                                    <li>計量機ノズルから2L程度の燃料を抜き取る。</li>
                                    <li>特に灯油は、抜き取った油を透明な容器に入れ、水道水と比較し着色がないか確認する。（簡易色相チェック）</li>
                                    <li>試買検査の前には必ず実施する。</li>
                                </ol>
                            </details>
                        </div>
                        <!-- 荷卸し立会い -->
                        <div class="bg-stone-100 p-6 rounded-lg transition duration-300 task-card">
                            <h3 class="text-lg font-semibold mb-2 flex items-center"><span class="text-2xl mr-3">🚚</span>荷卸し時の立会い・確認</h3>
                            <p class="text-sm text-stone-600 mb-4">コンタミネーション（異油種・水分混入）を防ぐため、荷卸し時の確認を徹底します。</p>
                             <details class="text-sm">
                                <summary class="font-medium text-sky-600 cursor-pointer">確認項目</summary>
                                <ul class="list-disc list-inside mt-2 space-y-2 text-stone-700">
                                    <li>受入油種と数量の確認。</li>
                                    <li>注油口とホースの正しい結合を確認。</li>
                                    <li>地下タンクの在庫量（受入前・後）の確認。</li>
                                    <li>ローリー乗務員と相互に配管内の残油がないか確認。</li>
                                </ul>
                            </details>
                        </div>
                        <!-- 目視確認 -->
                        <div class="bg-stone-100 p-6 rounded-lg transition duration-300 task-card">
                             <h3 class="text-lg font-semibold mb-2 flex items-center"><span class="text-2xl mr-3">👀</span>水分混入の目視確認</h3>
                            <p class="text-sm text-stone-600 mb-4">計量機から吐出される油の状態を日常的に観察し、水コンタミの初期兆候を発見します。</p>
                            <details class="text-sm">
                                <summary class="font-medium text-sky-600 cursor-pointer">チェックポイント</summary>
                                <ul class="list-disc list-inside mt-2 space-y-2 text-stone-700">
                                    <li>吐出油が白濁していないか？</li>
                                    <li>エア噛みのような音や振動はないか？</li>
                                    <li>在庫管理表で在庫量の不自然な増加はないか？</li>
                                    <li>集中豪雨や台風の後には特に注意する。</li>
                                </ul>
                            </details>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Standards Page -->
            <section id="standards-page" class="page">
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h2 class="text-2xl font-bold mb-2 text-stone-800">燃料油品質規格</h2>
                    <p class="text-stone-600 mb-6">品確法で定められた燃料油の品質規格（強制規格・標準規格）を検索・確認できます。油種を選択してください。</p>
                    <div class="mb-4">
                        <select id="fuel-type-selector" class="w-full md:w-1/3 p-2 border border-stone-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
                            <option value="gasoline">揮発油（ガソリン）</option>
                            <option value="diesel">軽油</option>
                            <option value="kerosene" selected>灯油</option>
                        </select>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-stone-500">
                            <thead class="text-xs text-stone-700 uppercase bg-stone-100">
                                <tr>
                                    <th scope="col" class="px-3 py-2 sm:px-6 sm:py-3">項目</th>
                                    <th scope="col" class="px-3 py-2 sm:px-6 sm:py-3">基準</th>
                                    <th scope="col" class="px-3 py-2 sm:px-6 sm:py-3">観点</th>
                                    <th scope="col" class="px-3 py-2 sm:px-6 sm:py-3">規格</th>
                                </tr>
                            </thead>
                            <tbody id="standards-table-body">
                                <!-- JS will populate this -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Emergency Page -->
            <section id="emergency-page" class="page">
                 <div class="bg-red-50 border-l-4 border-red-500 p-6 rounded-lg shadow-sm">
                    <h2 class="text-2xl font-bold mb-2 text-red-800">緊急時対応手順</h2>
                    <p class="text-red-700 mb-6">品質クレームやコンタミ事故が発生した場合、パニックにならず、以下の手順に従って冷静に対応してください。初動の速さが被害拡大を防ぎます。</p>
                    
                    <div id="emergency-steps-container">
                        <!-- Step 1 -->
                        <div class="emergency-step p-5 bg-white rounded-lg shadow-md mb-4">
                            <h3 class="text-xl font-bold text-red-600 mb-2">ステップ1：直ちに販売を停止</h3>
                            <p class="text-stone-700">お客様からのクレーム（「給油後、エンジンが止まった」など）や、自身の確認で異常を発見した場合、該当する計量機での販売を<strong>直ちに停止</strong>してください。これが最優先事項です。</p>
                        </div>
                        <!-- Step 2 -->
                         <div class="emergency-step p-5 bg-white rounded-lg shadow-md mb-4">
                            <h3 class="text-xl font-bold text-red-600 mb-2">ステップ2：責任者への報告</h3>
                            <p class="text-stone-700">速やかに品質管理者または店長へ状況を報告してください。自己判断で対応を続けないでください。</p>
                        </div>
                        <!-- Step 3 -->
                         <div class="emergency-step p-5 bg-white rounded-lg shadow-md mb-4">
                            <h3 class="text-xl font-bold text-red-600 mb-2">ステップ3：関係機関への連絡</h3>
                            <p class="text-stone-700 mb-4">品質管理者は、以下の関係機関へ速やかに連絡してください。</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="border border-stone-200 p-4 rounded-lg">
                                    <h4 class="font-semibold text-stone-800">① 最寄りの消防本部</h4>
                                    <p class="text-sm text-stone-600">事故の経緯、対応状況を報告。</p>
                                </div>
                                <div class="border border-stone-200 p-4 rounded-lg">
                                    <h4 class="font-semibold text-stone-800">② 元売事業者</h4>
                                    <p class="text-sm text-stone-600">社内規定に基づき連絡。</p>
                                </div>
                                <div class="border border-stone-200 p-4 rounded-lg md:col-span-2">
                                    <h4 class="font-semibold text-stone-800">③ 中部経済産業局 資源・燃料課</h4>
                                    <p class="text-lg font-mono font-bold my-2"><a href="tel:052-951-2781" class="text-sky-600 hover:underline">📞 052-951-2781</a></p>
                                    <details class="text-sm">
                                        <summary class="font-medium text-sky-600 cursor-pointer">伝えるべき事項</summary>
                                        <ol class="list-decimal list-inside mt-2 space-y-1 text-stone-700">
                                            <li>販売事業者名、給油所名</li>
                                            <li>給油所所在地</li>
                                            <li>連絡が取れる電話番号</li>
                                            <li>コンタミの概要（例：灯油に揮発油混入）</li>
                                            <li>直前に当該燃料の荷卸しを受けた事業者名</li>
                                        </ol>
                                        <p class="mt-2 text-xs text-stone-500">※休日・時間外は留守番電話に応答メッセージを残してください。</p>
                                    </details>
                                </div>
                            </div>
                        </div>
                    </div>
                 </div>
            </section>

            <!-- Learning Page -->
            <section id="learning-page" class="page">
                 <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h2 class="text-2xl font-bold mb-2 text-stone-800">学習モード</h2>
                    <p class="text-stone-600 mb-6">品質管理の基本をクイズ形式で学びましょう。新入社員の教育や、知識の再確認にご活用ください。</p>
                    
                    <div id="quiz-container">
                        <!-- Quiz questions will be injected here by JS -->
                    </div>

                    <div id="quiz-result" class="mt-6 p-4 rounded-lg text-center hidden"></div>
                    <button id="submit-quiz-btn" class="mt-6 w-full bg-sky-500 text-white font-semibold py-3 px-4 rounded-lg hover:bg-sky-600 transition duration-200">回答を送信</button>
                </div>
            </section>

            <!-- Documents Page -->
            <section id="documents-page" class="page">
                 <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h2 class="text-2xl font-bold mb-2 text-stone-800">資料</h2>
                    <p class="text-stone-600 mb-6">品質管理に関連する重要な資料はこちらから参照できます。</p>
                    <div class="space-y-4">
                        <a href="https://drive.google.com/file/d/1UHO6SKxEOz2kWs8qQOAXXhSQbnDxCtD7/view?usp=sharing" target="_blank" class="flex items-center p-4 bg-stone-100 rounded-lg hover:bg-stone-200 transition duration-200">
                            <span class="text-red-500 text-2xl mr-3">📄</span>
                            <span class="font-medium text-stone-800">品確法教育用資料「給油所の運営にあたって」.pdf</span>
                        </a>
                        <a href="https://drive.google.com/file/d/1UGrY8OLCYYnKBcGPC05YijzyrWC8DdiG/view?usp=sharing" target="_blank" class="flex items-center p-4 bg-stone-100 rounded-lg hover:bg-stone-200 transition duration-200">
                            <span class="text-red-500 text-2xl mr-3">📄</span>
                            <span class="font-medium text-stone-800">端切りの重要性と品確法2025.pdf</span>
                        </a>
                    </div>
                </div>
            </section>

            <!-- FAX Notifications Page -->
            <section id="fax-notifications-page" class="page">
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h2 class="text-2xl font-bold mb-2 text-stone-800">本社からの通知FAX</h2>
                    <p class="text-stone-600 mb-6">本社から発信された品質管理に関するFAX通知を、日付の新しい順に確認できます。</p>
                    <div id="fax-files-list" class="space-y-4">
                        <!-- FAX files will be populated here by JS -->
                    </div>
                </div>
            </section>

            <!-- Incident Assistant Page -->
            <section id="incident-assistant-page" class="page">
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h2 class="text-2xl font-bold mb-2 text-stone-800">AI事故アシスタント ✨</h2>
                    <p class="text-stone-600 mb-6">品質に関する事故や異常が発生した際に、その状況を入力してください。AIが原因の可能性や、推奨される対応を提案します。</p>
                    
                    <div class="mb-4">
                        <label for="incident-description" class="block text-stone-700 text-sm font-bold mb-2">事故の状況を具体的に入力してください:</label>
                        <textarea id="incident-description" class="shadow appearance-none border rounded w-full py-3 px-4 text-stone-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-sky-500" rows="6" placeholder="例: お客様が給油後、エンジンの不調を訴えました。直前に大雨がありました。"></textarea>
                    </div>
                    <button id="analyze-incident-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg focus:outline-none focus:shadow-outline transition duration-200">
                        ✨ 状況を分析する
                    </button>
                    
                    <div id="incident-analysis-result" class="mt-6 p-4 bg-stone-100 rounded-lg shadow hidden">
                        <p class="text-stone-500 text-center" id="analysis-loading-indicator">分析中...</p>
                        <div id="analysis-content" class="hidden">
                            <h3 class="text-xl font-semibold mb-3 text-stone-800">分析結果</h3>
                            <div class="mb-4">
                                <h4 class="font-semibold text-stone-700 mb-1">事象の要約:</h4>
                                <p id="analysis-summary" class="text-stone-600"></p>
                            </div>
                            <div class="mb-4">
                                <h4 class="font-semibold text-stone-700 mb-1">考えられる原因/確認事項:</h4>
                                <ul id="analysis-causes" class="list-disc list-inside text-stone-600"></ul>
                            </div>
                            <div class="mb-4">
                                <h4 class="font-semibold text-stone-700 mb-1">推奨される初動対応:</h4>
                                <ul id="analysis-actions" class="list-disc list-inside text-stone-600">
                                    <li>直ちに該当油種の販売を停止し、<a href="#emergency" class="text-sky-600 hover:underline nav-link-internal">緊急時対応手順</a>を参照してください。</li>
                                </ul>
                            </div>
                            <div>
                                <h4 class="font-semibold text-stone-700 mb-1">追加で収集すべき情報:</h4>
                                <ul id="analysis-info" class="list-disc list-inside text-stone-600"></ul>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const app = {
                state: {
                    currentPage: 'dashboard',
                },
                
                faxFilesData: [
                    // NOTE: This data is intentionally ordered by date in DESCENDING order (newest first).
                    // The sorting logic in initFaxFilesList() further ensures this order.
                    { date: '20250611', name: '20250611荷卸し立会い優秀者.pdf', url: 'https://drive.google.com/file/d/1AiIySyEUoYK-eFX7864nI-UgHQi0_iwZ/view?usp=sharing' },
                    { date: '20250510', name: '20250510監査セルフチェックリスト.pdf', url: 'https://drive.google.com/file/d/1oi0xjmfGx-PyCWFXovYQJMAy1DnwM09j/view?usp=sharing' },
                    { date: '20250505', name: '20250505荷卸し作業動画.pdf', url: 'https://drive.google.com/file/d/1PLYGxN2hYC5gaBy3Gtn9QNVFbOUwcfte/view?usp=sharing' },
                    { date: '20250404', name: '20250404監査総括2025年3月.pdf', url: 'https://drive.google.com/file/d/18v8va-18Vt2I8TPTyQBOsFy6sbjFU2GK/view?usp=sharing' },
                    { date: '20250307', name: '20250307立ち会い時のハンディ使用について.pdf', url: 'https://drive.google.com/file/d/1r2VN6IpjOUb8cJnBPy1ggAMssZFJeTDK/view?usp=sharing' },
                    { date: '20250306', name: '20250306黒本の増減率について.pdf', url: 'https://drive.google.com/file/d/1y3V6Ijb4WFzgvFTJeNeue5WC9ZkvGWDz/view?usp=sharing' },
                    { date: '20250306', name: '20250306監査総括2025年2月分.pdf', url: 'https://drive.google.com/file/d/14pf2VX1i5hqCNg7waSTKrhzwYVgs93S0/view?usp=sharing' },
                    { date: '20250213', name: '20250213新人の荷卸し教育について.pdf', url: 'https://drive.google.com/file/d/1Sr0YgCBeRsGqo5jlLoA4hQMeZeGDVQTg/view?usp=sharing' },
                    { date: '20250210', name: '20250210開店時間前の荷卸しについて.pdf', url: 'https://drive.google.com/file/d/1AGkCpQaG45OcI4jkfhGaaHFPR5RSedGR/view?usp=sharing' },
                    { date: '20250206', name: '20250206前尺プリントのタイミングについて.pdf', url: 'https://drive.google.com/file/d/1rTS73u4vp_fMTRsrAzKU4CG3Sq-Sgxi3/view?usp=sharing' },
                    { date: '20250205', name: '20250205品質分析結果通知書の注意点.pdf', url: 'https://drive.google.com/file/d/1-eZR8ZqaoYrBc1bc8xr0ZdkgkXLl5xvu/view?usp=sharing' },
                    { date: '20250131', name: '20250131荷卸し立会い強化月間.pdf', url: 'https://drive.google.com/file/d/110ZbtZ1jtS7289Klhw6bG9ukUMrmCODt/view?usp=sharing' },
                ],
                
                // initRouterメソッドをinit()よりも前に定義
                initRouter() {
                    const navLinks = document.querySelectorAll('.nav-item');
                    navLinks.forEach(link => {
                        if (link.getAttribute('href').startsWith('http') || link.getAttribute('href').startsWith('https')) {
                            return;
                        }
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            const pageId = link.getAttribute('href').substring(1);
                            this.navigateTo(pageId);
                        });
                    });
                    const initialPage = window.location.hash ? window.location.hash.substring(1) : 'dashboard';
                    this.navigateTo(initialPage);
                },

                navigateTo(pageId) {
                    this.state.currentPage = pageId;
                    window.location.hash = pageId;
                    this.renderPage();
                },

                renderPage() {
                    document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
                    const newPage = document.getElementById(`${this.state.currentPage}-page`);
                    if (newPage) {
                        newPage.classList.add('active');
                    } else {
                        document.getElementById('dashboard-page').classList.add('active');
                    }

                    document.querySelectorAll('.nav-item').forEach(link => {
                        if (link.getAttribute('href').startsWith('http') || link.getAttribute('href').startsWith('https')) {
                            link.classList.remove('active');
                            return;
                        }
                        if (link.getAttribute('href') === `#${this.state.currentPage}`) {
                            link.classList.add('active');
                        } else {
                            link.classList.remove('active');
                        }
                    });
                },
                
                causesData: {
                    labels: ['ホース内滞油(端切り不足)', 'ローリーからのコンタミ', '計量機・配管の劣化', '施設への水分侵入', 'その他'],
                    datasets: [{
                        label: '不適合件数（イメージ）',
                        data: [45, 30, 15, 8, 2],
                        backgroundColor: ['#38bdf8', '#60a5fa', '#93c5fd', '#bfdbfe', '#e0f2fe'],
                        borderColor: ['#0284c7', '#2563eb', '#60a5fa', '#93c5fd', '#dbeafe'],
                        borderWidth: 1
                    }]
                },

                initCharts() {
                    const ctx = document.getElementById('causesChart').getContext('2d');
                    new Chart(ctx, {
                        type: 'bar',
                        data: this.causesData,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            indexAxis: 'y',
                            scales: {
                                x: {
                                    beginAtZero: true,
                                    title: { display: true, text: '発生頻度' }
                                }
                            },
                            plugins: {
                                legend: { display: false },
                                title: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return ` ${context.dataset.label}: ${context.raw}%`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                },

                standardsData: {
                    gasoline: [
                        { item: '鉛', spec: '検出されないこと', reason: '環境(大気汚染防止)', type: '強制' },
                        { item: '硫黄分', spec: '0.001質量%(10ppm)以下', reason: '環境(大気汚染防止)', type: '強制' },
                        { item: 'ベンゼン', spec: '1体積%以下', reason: '健康被害防止', type: '強制' },
                        { item: '灯油混入率', spec: '4体積%以下', reason: 'エンジントラブル防止', type: '強制' },
                        { item: '色', spec: 'オレンジ色', reason: '灯油との誤使用防止', type: '標準' },
                        { item: 'オクタン価', spec: '1号(ハイオク)96以上, 2号(レギュラー)89以上', reason: '運転時の快適性', type: '標準' },
                    ],
                    diesel: [
                        { item: '硫黄分', spec: '0.001質量%(10ppm)以下', reason: '環境(大気汚染防止)', type: '強制' },
                        { item: 'セタン指数', spec: '45以上', reason: '環境(大気汚染防止)', type: '強制' },
                        { item: '蒸留性状(90%留出温度)', spec: '360℃以下', reason: '環境(大気汚染防止)', type: '強制' },
                        { item: '引火点', spec: '45℃以上', reason: '安全性', type: '標準' },
                        { item: '流動点', spec: '季節・地域により異なる', reason: '運転時の快適性', type: '標準' },
                    ],
                    kerosene: [
                        { item: '硫黄分', spec: '0.008質量%(80ppm)以下', reason: '環境(大気汚染防止)', type: '強制' },
                        { item: '引火点', spec: '40℃以上', reason: '消費者安全の確保', type: '強制' },
                        { item: '色', spec: 'セーボルト色が+25以上 (無色透明)', reason: 'ガソリンとの誤使用防止', type: '標準' },
                        { item: '煙点', spec: '23mm以上', reason: '快適性', type: '標準' },
                    ]
                },

                initStandardsTable() {
                    // Initialize with kerosene as default
                    this.renderStandardsTable('kerosene');
                },

                renderStandardsTable(fuelType) {
                    const tableBody = document.getElementById('standards-table-body');
                    tableBody.innerHTML = '';
                    const data = this.standardsData[fuelType] || [];
                    data.forEach(std => {
                        const row = document.createElement('tr');
                        row.className = 'bg-white border-b hover:bg-stone-50';
                        row.innerHTML = `
                            <td class="px-3 py-2 sm:px-6 sm:py-4 font-medium text-stone-900 whitespace-nowrap">${std.item}</td>
                            <td class="px-3 py-2 sm:px-6 sm:py-4">${std.spec}</td>
                            <td class="px-3 py-2 sm:px-6 sm:py-4 break-words">${std.reason}</td>
                            <td class="px-3 py-2 sm:px-6 sm:py-4">
                                <span class="px-2 py-1 font-semibold leading-tight rounded-full ${std.type === '強制' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">
                                    ${std.type}
                                </span>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                },

                initQuiz() {
                    const quizContainer = document.getElementById('quiz-container');
                    quizContainer.innerHTML = '<p class="text-stone-500">現在、クイズデータはありません。</p>';
                    document.getElementById('submit-quiz-btn').style.display = 'none';
                },
                
                submitQuiz() {
                    console.log("クイズデータがないため、送信処理は実行されません。");
                },

                initFaxFilesList() {
                    const faxFilesListContainer = document.getElementById('fax-files-list');
                    this.faxFilesData = [
                        { date: '20250611', name: '20250611荷卸し立会い優秀者.pdf', url: 'https://drive.google.com/file/d/1AiIySyEUoYK-eFX7864nI-UgHQi0_iwZ/view?usp=sharing' },
                        { date: '20250510', name: '20250510監査セルフチェックリスト.pdf', url: 'https://drive.google.com/file/d/1oi0xjmfGx-PyCWFXovYQJMAy1DnwM09j/view?usp=sharing' },
                        { date: '20250505', name: '20250505荷卸し作業動画.pdf', url: 'https://drive.google.com/file/d/1PLYGxN2hYC5gaBy3Gtn9QNVFbOUwcfte/view?usp=sharing' },
                        { date: '20250404', name: '20250404監査総括2025年3月.pdf', url: 'https://drive.google.com/file/d/18v8va-18Vt2I8TPTyQBOsFy6sbjFU2GK/view?usp=sharing' },
                        { date: '20250307', name: '20250307立ち会い時のハンディ使用について.pdf', url: 'https://drive.google.com/file/d/1r2VN6IpjOUb8cJnBPy1ggAMssZFJeTDK/view?usp=sharing' },
                        { date: '20250306', name: '20250306黒本の増減率について.pdf', url: 'https://drive.google.com/file/d/1y3V6Ijb4WFzgvFTJeNeue5WC9ZkvGWDz/view?usp=sharing' },
                        { date: '20250306', name: '20250306監査総括2025年2月分.pdf', url: 'https://drive.google.com/file/d/14pf2VX1i5hqCNg7waSTKrhzwYVgs93S0/view?usp=sharing' },
                        { date: '20250213', name: '20250213新人の荷卸し教育について.pdf', url: 'https://drive.google.com/file/d/1Sr0YgCBeRsGqo5jlLoA4hQMeZeGDVQTg/view?usp=sharing' },
                        { date: '20250210', name: '20250210開店時間前の荷卸しについて.pdf', url: 'https://drive.google.com/file/d/1AGkCpQaG45OcI4jkfhGaaHFPR5RSedGR/view?usp=sharing' },
                        { date: '20250206', name: '20250206前尺プリントのタイミングについて.pdf', url: 'https://drive.google.com/file/d/1rTS73u4vp_fMTRsrAzKU4CG3Sq-Sgxi3/view?usp=sharing' },
                        { date: '20250205', name: '20250205品質分析結果通知書の注意点.pdf', url: 'https://drive.google.com/file/d/1-eZR8ZqaoYrBc1bc8xr0ZdkgkXLl5xvu/view?usp=sharing' },
                        { date: '20250131', name: '20250131荷卸し立会い強化月間.pdf', url: 'https://drive.google.com/file/d/110ZbtZ1jtS7289Klhw6bG9ukUMrmCODt/view?usp=sharing' },
                    ];
                    // Sort in descending order by date (8-digit prefix)
                    this.faxFilesData.sort((a, b) => b.date.localeCompare(a.date));

                    this.faxFilesData.forEach(file => {
                        const fileLink = document.createElement('a');
                        fileLink.href = file.url;
                        fileLink.target = "_blank";
                        fileLink.className = "flex items-center p-4 bg-stone-100 rounded-lg hover:bg-stone-200 transition duration-200";
                        fileLink.innerHTML = `
                            <span class="text-xl mr-3">🖷</span> <!-- FAXの絵文字に変更 -->
                            <span class="font-medium text-stone-800">${file.name}</span>
                        `;
                        faxFilesListContainer.appendChild(fileLink);
                    });
                },

                async initIncidentAssistant() {
                    const analyzeButton = document.getElementById('analyze-incident-btn');
                    const descriptionInput = document.getElementById('incident-description');
                    const resultDiv = document.getElementById('incident-analysis-result');
                    const loadingIndicator = document.getElementById('analysis-loading-indicator');
                    const analysisContent = document.getElementById('analysis-content');
                    const analysisSummary = document.getElementById('analysis-summary');
                    const analysisCauses = document.getElementById('analysis-causes');
                    const analysisActions = document.getElementById('analysis-actions');
                    const analysisInfo = document.getElementById('analysis-info');

                    analyzeButton.addEventListener('click', async () => {
                        const incidentDescription = descriptionInput.value.trim();
                        if (!incidentDescription) {
                            alert('事故の状況を入力してください。'); // Replace with custom modal if preferred
                            return;
                        }

                        resultDiv.classList.remove('hidden');
                        loadingIndicator.classList.remove('hidden');
                        analysisContent.classList.add('hidden');
                        analysisCauses.innerHTML = '';
                        analysisInfo.innerHTML = '';
                        analysisActions.innerHTML = '<li>直ちに該当油種の販売を停止し、<a href="#emergency" class="text-sky-600 hover:underline nav-link-internal">緊急時対応手順</a>を参照してください。</li>'; // Reset to default action

                        try {
                            const prompt = `あなたはガソリンスタンドの品質管理アシスタントです。以下の事故状況を分析し、事象の要約、考えられる原因/確認事項（箇条書き）、推奨される初動対応（箇条書き）、および追加で収集すべき情報（箇条書き）をJSON形式で提供してください。原因は具体的な可能性を複数挙げてください。

事故状況: ${incidentDescription}

JSONフォーマットの例:
{
  "summary": "要約テキスト",
  "causes": ["原因1", "原因2", "原因3"],
  "actions": ["行動1", "行動2"],
  "info_to_gather": ["情報1", "情報2"]
}`;

                            let chatHistory = [];
                            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                            const payload = {
                                contents: chatHistory,
                                generationConfig: {
                                    responseMimeType: "application/json",
                                    responseSchema: {
                                        type: "OBJECT",
                                        properties: {
                                            "summary": { "type": "STRING" },
                                            "causes": { "type": "ARRAY", "items": { "type": "STRING" } },
                                            "actions": { "type": "ARRAY", "items": { "type": "STRING" } },
                                            "info_to_gather": { "type": "ARRAY", "items": { "type": "STRING" } }
                                        },
                                        "propertyOrdering": ["summary", "causes", "actions", "info_to_gather"]
                                    }
                                }
                            };
                            const apiKey = ""; // If you want to use models other than gemini-2.0-flash or imagen-3.0-generate-002, provide an API key here. Otherwise, leave this as-is.
                            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                            
                            const response = await fetch(apiUrl, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });
                            
                            const result = await response.json();
                            
                            if (result.candidates && result.candidates.length > 0 &&
                                result.candidates[0].content && result.candidates[0].content.parts &&
                                result.candidates[0].content.parts.length > 0) {
                                const jsonText = result.candidates[0].content.parts[0].text;
                                const parsedJson = JSON.parse(jsonText);

                                analysisSummary.textContent = parsedJson.summary;
                                parsedJson.causes.forEach(cause => {
                                    const li = document.createElement('li');
                                    li.textContent = cause;
                                    analysisCauses.appendChild(li);
                                });
                                // Preserve default action, add new actions if present
                                parsedJson.actions.forEach(action => {
                                    if (!analysisActions.innerHTML.includes(action)) { // Avoid duplicating default action if LLM generates it
                                        const li = document.createElement('li');
                                        li.textContent = action;
                                        analysisActions.appendChild(li);
                                    }
                                });
                                parsedJson.info_to_gather.forEach(info => {
                                    const li = document.createElement('li');
                                    li.textContent = info;
                                    analysisInfo.appendChild(li);
                                });

                                loadingIndicator.classList.add('hidden');
                                analysisContent.classList.remove('hidden');
                            } else {
                                loadingIndicator.textContent = '分析結果を取得できませんでした。';
                                console.error('Unexpected LLM response structure:', result);
                            }
                        } catch (error) {
                            loadingIndicator.textContent = '分析中にエラーが発生しました。';
                            console.error('Error calling LLM:', error);
                        } finally {
                             // Re-attach internal navigation listeners to newly added content
                            document.querySelectorAll('#incident-analysis-result .nav-link-internal').forEach(link => {
                                link.removeEventListener('click', app.internalNavLinkHandler); // Remove old listener if exists
                                link.addEventListener('click', app.internalNavLinkHandler); // Add new listener
                            });
                        }
                    });
                     // Define the handler once to remove/add it easily
                    this.internalNavLinkHandler = (e) => {
                        e.preventDefault();
                        const targetId = e.target.getAttribute('href').substring(1);
                        this.navigateTo(targetId);
                    };
                },

                // Ensure init and other methods are properly ordered after their dependencies
                init() {
                    this.initRouter();
                    this.renderPage();
                    this.initCharts();
                    this.initStandardsTable();
                    this.initQuiz();
                    this.initFaxFilesList();
                    this.initIncidentAssistant(); // Now this call should work
                    
                    document.getElementById('fuel-type-selector').addEventListener('change', (e) => this.renderStandardsTable(e.target.value));
                    
                    document.querySelectorAll('.nav-link-internal').forEach(link => {
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            const targetId = link.getAttribute('href').substring(1);
                            this.navigateTo(targetId);
                        });
                    });
                }
            };

            app.init();
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>荷卸し作業テスト</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 20px;
        }
        #name-input-container {
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            max-width: 600px;
            margin: auto;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #quiz, #result {
            display: none;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            max-width: 600px;
            margin: auto;
            text-align: left;
        }
        #start {
            display: none;
        }
        .hidden {
            display: none;
        }
        .explanation-correct {
            color: #218838;
            background-color: #f0fdf4;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        .explanation-incorrect {
            color: #c82333;
            background-color: #fef0f0;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .explanation-title {
            font-weight: bold;
            margin-top: 15px;
            margin-bottom: 5px;
        }
        #name-select {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            width: 250px;
        }
        #name-input-container button{
            padding: 10px 20px;
            border-radius: 5px;
            background-color: #007bff;
            color: #fff;
            border: none;
            cursor: pointer;
        }
        #name-input-container button:hover {
            background-color: #0056b3;
        }
       #result {
            text-align: center;
        }
        #result-summary {
            font-size: 1.2em;
            margin-bottom: 20px;
            font-weight: bold;
        }
        #update-date {
            font-size: 0.8em;
            color: #888;
            margin-top: 10px;
        }
        #version {
            font-size: 0.8em;
            color: #888;
            margin-top: 5px;
        }
        #all-answers {
            margin-top: 20px;
            text-align: left;
        }
        #download-button {
            margin-top: 20px;
        }

    </style>
</head>
<body>
    <h1>荷卸し作業テスト</h1>
    <div id="update-date">更新日：2025年5月1日 18:38</div>
    <div id="version">バージョン：1.0.1</div>  <div id="name-input-container">
        <label for="name-select">所属店舗を選択してください：</label><br>
        <select id="name-select" name="name" required>
            <option value="">選択してください</option>
            <option value="緑ヶ丘">緑ヶ丘</option>
            <option value="花園">花園</option>
            <option value="八幡">八幡</option>
            <option value="長浦">長浦</option>
            <option value="高棚">高棚</option>
            <option value="豊明東">豊明東</option>
            <option value="羽根">羽根</羽根</option>
            <option value="東浦スタンド">東浦スタンド</option>
            <option value="東浦検査場">東浦検査場</option>
            <option value="大府スタンド">大府スタンド</option>
            <option value="大府検査場">大府検査場</option>
            <option value="幸田スタンド">幸田スタンド</option>
            <option value="三河検査場">三河検査場</三河検査場</option>
            <option value="常滑スタンド">常滑スタンド</常滑スタンド</option>
            <option value="常滑検査場">常滑検査場</常滑検査場</option>
            <option value="豊明">豊明</豊明</option>
            <option value="稲穂">稲穂</稲穂</option>
            <option value="東海長口">東海長口</東海長口</option>
            <option value="豊田上丘">豊田上丘</豊田上丘</option>
            <option value="岡崎定国">岡崎定国</岡崎定国</option>
            <option value="三ヶ根">三ヶ根</三ヶ根</option>
            <option value="日進">日進</日進</option>
            <option value="阿久比">阿久比</阿久比</option>
            <option value="刈谷">刈谷</刈谷</option>
            <option value="西尾">西尾</西尾</option>
            <option value="トレーラー配送部">トレーラー配送部</トレーラー配送部</option>
            <option value="本社事務所">本社事務所</本社事務所</option>
            <option value="レッカー">レッカー</レッカー</option>
        </select>
        <label for="name-input">お名前を入力してください：</label><br>
        <input type="text" id="name-input" name="name" required>
        <button onclick="startQuiz()">テスト開始</button>
    </div>

    <div id="quiz" class="hidden">
        <p id="question"></p>
        <div id="options"></div>
        <br>
        <button onclick="checkAnswer()">解答する</button>
    </div>

    <div id="result" class="hidden">
        <p id="result-summary"></p>
        <p id="explanation"></p>
        <div id="all-answers"></div>
        <button id="nextButton" onclick="nextQuestion()">次へ</button>
    </div>

    <script>
        const questions = [
            { q: "前尺を測定する目的は何ですか？", options: ["荷卸し数量を確認するため", "空間容量を確認し、油が入るか判断するため", "タンクの圧力を確認するため", "油種を識別するため"], answer: 1, explanation: "前尺はタンクにどれだけの油が入るかを確認するために行います。" },
            { q: "荷卸し前に吐出口のコックを全て閉める目的は？", options: ["油種の一致確認のため", "余計な油が流出しないようにするため", "荷卸し数量を調整するため", "油種の品質を確認するため"], answer: 1, explanation: "漏洩事故防止のため、吐出口のコックは閉めておきます。" },
            { q: "積荷と吐出口の油種・数量の一致確認の手順は？", options: ["積荷のラベルを確認する", "ドライバーに油種クリップを見せて確認する", "吐出口の油種を声に出して確認し、ドライバーと一致確認する", "油種を試験紙で検査する"], answer: 2, explanation: "声に出して確認し、ダブルチェックを行うことが重要です。" },
            { q: "荷卸し作業の順序で最初に荷卸しするのはどの油種ですか？", options: ["レギュラー", "軽油", "灯油", "ハイオク"], answer: 2, explanation: "混油防止のため灯油を先に荷卸しします。" },
            { q: "荷卸し順序の決定で最も重要なポイントは？", options: ["作業スピードを優先する", "灯油を最後にする", "油種のコンタミを防ぐために順番を守る", "荷卸しの前に全てのタンクを空にする"], answer: 2, explanation: "混油（コンタミ）を防ぐ順序で作業するのが基本です。" },
            { q: "荷卸し順序を決定する際、適切な順番は？", options: ["軽油 → レギュラー → 灯油 → ハイオク", "灯油 → レギュラー → ハイオク → 軽油", "レギュラー → 軽油 → ハイオク → 灯油", "ハイオク → 灯油 → 軽油 → レギュラー"], answer: 1, explanation: "灯油を最初に荷卸しする順番が基本です。" },
            { q: "注油口を開けた時に行うべき確認事項は？", options: ["タンクの温度を測定する", "油種クリップとラベルを確認する", "パッキンの異常がないか確認する", "注油口の蓋を交換する"], answer: 2, explanation: "安全のためパッキンに異常がないかを確認します。" },
            { q: "ホースの接続時にドライバーと相互確認する項目は？", options: ["油種クリップ・注油口ラベル", "吐出口の開閉状況", "タンク内の油面", "荷卸しのスピード"], answer: 0, explanation: "油種ミス防止のため、接続先を相互に確認します。" },
            { q: "吐出口のコックを開放する前に確認すべき項目は？", options: ["サイトグラスで油種の色を確認する", "注油口の蓋が開いているか確認する", "油種クリップの色を変更する", "タンクの圧力を調整する"], answer: 0, explanation: "サイトグラスで流れる油の色を確認し油種一致を確かめます。" },
            { q: "サイトグラスにて確認する事項は何ですか？", options: ["油種の色", "タンクの温度", "油面の変化", "ホースの長さ"], answer: 0, explanation: "サイトグラスでは流れている油の色を確認できます。" },
            { q: "灯油の色は何色ですか？", options: ["無色透明", "橙色", "青色", "淡黄色"], answer: 0, explanation: "灯油は無色透明です。" },
            { q: "レギュラーの色は何色ですか？", options: ["無色透明", "橙色", "青色", "淡黄色"], answer: 1, explanation: "レギュラーは橙色に着色されています。" },
            { q: "ハイオクの色は何色ですか？", options: ["無色透明", "橙色", "青色", "淡黄色"], answer: 1, explanation: "ハイオクもレギュラー同様、橙色で識別されます。" },
            { q: "軽油の色は何色ですか？", options: ["無色透明", "橙色", "赤色", "淡黄色"], answer: 3, explanation: "軽油は淡黄色に着色されています。" },
            { q: "荷卸し開始時に確認すべき項目は？", options: ["吐出口の開閉状況", "タンクの温度", "油漏れがないか", "ホースの長さ"], answer: 2, explanation: "荷卸し直後の漏洩確認は重要です。" },
            { q: "荷卸し作業中に異常が発生した場合の対応は？", options: ["すぐに荷卸しを停止し、原因を確認する", "立会人がいる場合はそのまま作業を続ける", "ドライバーに確認しながら作業を進める", "まずタンク内の油量を再確認する"], answer: 0, explanation: "異常が発生したら即座に作業を中断し、安全確認を行います。" },
            { q: "荷卸し作業中の安全監視で確認すべき事項は？", options: ["油面計やべーパー", "吐出口の開閉状況", "荷卸しスピード", "ドライバーの名前"], answer: 0, explanation: "安全装置（油面計・ベーパー）で常時監視します。" },
            { q: "荷卸し中に場を離れる際、行うべき対応は？", options: ["吐出口コックを閉止する", "タンクの蓋を閉める", "ホースを取り外す", "ドライバーに荷卸しを任せる"], answer: 0, explanation: "場を離れる時は、必ずコックを閉止し安全確保します。" },
            { q: "荷卸し終了後、最初に確認すべき項目は？", options: ["配管内の残油がないか", "注油口のパッキンの異常", "油種クリップの色", "吐出口の開閉状況"], answer: 0, explanation: "残油が残っていないかを確認し、漏洩防止を図ります。" },
            { q: "荷卸し終了後、後尺を測定する目的は？", options: ["荷卸し数量の異常やコンタミを確認するため", "注油口のラベルを確認するため", "ホースの接続状態を確認するため", "トラックの車輪の状態を確認するため"], answer: 0, explanation: "後尺測定により、荷卸し数量の妥当性や混油の有無を確認します。" },
            { q: "後尺の異常基準は？", options: ["（前尺＋荷卸し数量）×101％＜後尺", "（荷卸し数量）×102％＞前尺", "（前尺＋荷卸し数量）×100％＞後尺", "（後尺）×99％＜前尺"], answer: 0, explanation: "後尺が101％を超えていたら、コンタミや測定ミスの可能性があります。" },
            { q: "荷卸し終了後にドライバーと相互に確認すべき内容は？", options: ["荷卸し数量と油種の一致", "ホースの接続状態", "タンクの温度", "油種クリップの色"], answer: 0, explanation: "数量・油種が合っていたか最終確認を必ず行います。" },
        ];

        let currentQuestionIndex = 0;
        let correctAnswers = 0; // 正解数を記録する変数
        let userName = ""; // ユーザー名を保存する変数
        let userAnswers = []; // ユーザーの回答を保存する配列
        // スプレッドシートIDとシート名
        const SPREADSHEET_ID = "15PEK4SbxGgZvaM2evzK6w2qI0qPb8qkggU_J-9oZOGk";  // ★  スプレッドシートID
        const SHEET_NAME = "シート1";             // ★  シート名
        const GAS_URL = "https://script.google.com/macros/s/AKfycbxaNPCJuLsJ5ec1OwptnW_JP7ms5J28RqmWq2KmBe33nKbQ-oy2bbs4UQLF3sFLAOmETg/exec"; //★ GASのURL
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/15PEK4SbxGgZvaM2evzK6w2qI0qPb8qkggU_J-9oZOGk/edit?hl=ja&pli=1&gid=0#gid=0"; //★ スプレッドシートのURL


        function startQuiz() {
            const nameSelect = document.getElementById("name-select");
            const nameInput = document.getElementById("name-input");
            userName = nameSelect.value + " " + nameInput.value;
            if (!nameSelect.value) {
                alert("所属店舗を選択してください。");
                return;
            }
            if (!nameInput.value.trim()) {
                alert("名前を入力してください。");
                return;
            }

            document.getElementById("name-input-container").style.display = "none";
            document.getElementById("quiz").style.display = "block";
            loadQuestion();
        }

        function loadQuestion() {
            if (currentQuestionIndex >= questions.length) {
                // 全ての問題が終了した場合の処理
                recordResult();
                return;
            }

            let questionData = questions[currentQuestionIndex];
            document.getElementById("question").innerText = questionData.q;

            let optionsHtml = "";
            questionData.options.forEach((option, index) => {
                optionsHtml += `<input type="radio" name="q1" value="${index}"> ${option}<br>`;
            });

            document.getElementById("options").innerHTML = optionsHtml;
        }

        function checkAnswer() {
            let answer = document.querySelector('input[name="q1"]:checked');

            if (!answer) {
                alert("選択肢を選んでください");
                return;
            }

            let questionData = questions[currentQuestionIndex];
            let explanationDiv = document.getElementById("explanation");
            explanationDiv.innerHTML = "";

            if (parseInt(answer.value) === questionData.answer) {
                correctAnswers++;
                const correctText = document.createElement("p");
                correctText.className = "explanation-correct";
                correctText.innerHTML = `✅ 正解： ${questionData.options[questionData.answer]}`;
                explanationDiv.appendChild(correctText);
                userAnswers.push(true); // 正解を記録

                const explanationTitle = document.createElement("p");
                explanationTitle.className = "explanation-title";
                explanationTitle.innerText = "📌 解説:";
                explanationDiv.appendChild(explanationTitle);

                const explanationText = document.createElement("p");
                explanationText.innerText = questionData.explanation;
                explanationDiv.appendChild(explanationText);

            } else {
                const incorrectText = document.createElement("p");
                incorrectText.className = "explanation-incorrect";
                incorrectText.innerHTML = `❌ 不正解です。<br><br>正解は： ${questionData.options[questionData.answer]}`;
                explanationDiv.appendChild(incorrectText);
                userAnswers.push(false); // 不正解を記録

                const explanationTitle = document.createElement("p");
                explanationTitle.className = "explanation-title";
                explanationTitle.innerText = "📌 解説:";
                explanationDiv.appendChild(explanationTitle);

                const explanationText = document.createElement("p");
                explanationText.innerText = questionData.explanation;
                explanationDiv.appendChild(explanationText);
            }

            document.getElementById("quiz").style.display = "none";
            document.getElementById("result").style.display = "block";
            document.getElementById("nextButton").style.display = "block";
        }

        function nextQuestion() {
            currentQuestionIndex++;

            if (currentQuestionIndex < questions.length) {
                document.getElementById("result").style.display = "none";
                document.getElementById("quiz").style.display = "block";
                loadQuestion();
            } else {
                recordResult();
            }
        }

        function recordResult() {
            const testResult = {
                name: userName,
                date: new Date().toLocaleString(),
                correct: correctAnswers,
                total: questions.length,
                answers: userAnswers // 回答履歴を保存
            };

            // 結果表示
            const resultSummary = document.getElementById("result-summary");
            resultSummary.innerHTML = `お疲れ様でした！<br>あなたの成績は ${questions.length}問中 ${correctAnswers}問正解でした。<br><a href="${SHEET_URL}" target="_blank">結果はスプレッドシートで確認できます</a>`; // スプレッドシートのURLを表示するよう修正

            // 全問の正誤を表示
            let allAnswersDiv = document.getElementById("all-answers");
            let allAnswersHTML = "<h3>あなたの回答</h3><ul>";
            questions.forEach((question, index) => {
                const resultText = userAnswers[index] ? "✅ 正解" : "❌ 不正解";
                allAnswersHTML += `<li>第${index + 1}問：${resultText}</li>`;
            });
            allAnswersHTML += "</ul>";
            allAnswersDiv.innerHTML = allAnswersHTML;

            // Google Apps Scriptに結果を送信
            fetch(GAS_URL, {  // ★  GASのURL
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(testResult)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Success:', data);
                 // 成功した場合、CSVダウンロードボタンを非表示にするなどの処理もここに記述できます
                // document.getElementById("download-button").style.display = "none";
                 alert("結果をGoogleスプレッドシートに記録しました。お疲れ様でした。");
            })
            .catch(error => {
                console.error("Error:", error);
                alert("結果の記録に失敗しました。お疲れ様でした。");
            });

            document.getElementById("result").style.display = "none";
            document.getElementById("start").style.display = "block";
            currentQuestionIndex = 0;
            correctAnswers = 0;
            userAnswers = [];
        }



        function downloadCsv() {
            // localStorageから結果を取得する代わりに、現在の結果を使用
            const testResult = {
                name: userName,
                date: new Date().toLocaleString(),
                correct: correctAnswers,
                total: questions.length,
                answers: userAnswers
            };

            // CSV形式のデータを作成
            let csvContent = "参加者,日時,正解数,総問題数,";
            questions.forEach((question, index) => {
                csvContent += `第${index + 1}問,`;
            });
            csvContent += "\n";

            csvContent += `${testResult.name},${testResult.date},${testResult.correct},${testResult.total},`;
            testResult.answers.forEach(answer => {
                csvContent += answer ? "正解," : "不正解,";
            });
            csvContent += "\n";

            // BOMを付与してUTF-8で正しく表示されるようにする
            const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
            const csvBlob = new Blob([bom, csvContent], { type: 'text/csv;charset=utf-8;' });
            const csvUrl = URL.createObjectURL(csvBlob);

            // ダウンロードリンクを作成してクリック
            const link = document.createElement("a");
            link.href = csvUrl;
            link.setAttribute("download", "test_result.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(csvUrl);

            alert("結果をCSVファイルとしてダウンロードしました。お疲れ様でした。");
        }

        function displayDateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0'); // 月は0から始まるため+1
            const day = String(now.getDate()).padStart(2, '0');

            const dateString = `${year}年${month}月${day}日`;
            document.getElementById("current-datetime").textContent = dateString;
        }
    </script>
</body>
</html>
